<!-- collection/collection_create_beta.html -->
{% extends "main/base.html" %}
{% load leaflet_tags %}
{% load fontawesome %}
{% load static %}
{% load dataset_extras %}
{% block title %}<title>WHG::Create/Update Collection (beta)</title>{% endblock %}
{% block extra_head %}
  {% leaflet_js %}
  {% leaflet_css %}
  
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.css' rel='stylesheet' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.js'></script>
  <script src="{% static 'js/leaflet-mapbox-gl.js' %}"></script>

  <style>
    .coll-col { border-right: 1px dashed lightgray;;}
    #coll_place_detail{
	    border-bottom:dashed 1px grey;
	    background-color: aliceblue;
    }
    #coll_place_detail p{ margin-bottom: 0;}
    #anno_div input {height: 1.5rem; font-size:.8rem;}
  </style>
{% endblock %}

{% block content %}
<div class="container container-md" style="height: calc(100vh - 65px);">
  <!--owner or superuser: {{user.id}} {{object.owner.id}}-->
  {% if action == 'update' and user.id != object.owner.id and not user.is_superuser %}
	  <p>Access to this page is limited to the collection owner, <b>{{ user.username }} ({{object.owner.id}})</b></p>
  {% else %}
	  <h4 class="mt-3">
    {% if action == 'update' %}
	    Update Place Collection: <span class="text-danger">"{{ form.title.value }}"</span>
    <a href="{% url 'collection:collection-delete' object.id %}" class="float-right"
      title="Delete collection" rel="tooltip" style="margin-top:-2px;">
      {% fontawesome_icon 'trash' color='#336699' %}</a>
    {% else %}
	    Create Place Collection
    {% endif %} <span class="red-head"> </span>
	  </h4>
	  <div class="d-flex h-100">
	    <div id="coll_form" class="form-box mt-2 coll-col col-sm-4" style="height: 85%;">
	      <form id="collection_form" method="POST" action="#" enctype="multipart/form-data">
	      {% csrf_token %}
	      <input type="hidden" name="owner" value='{{ user.id }}' />
		      <p>Title &#x02733;<span class="closer float-right"><<</span><br/>{{ form.title }}</p>
	      {% if action == 'update' %}
	        <p>Create date: {{ create_date }}</p>
	      {% endif %}
	      <p><span class="top">Description &#x02733;</span><br/>{{ form.description }}</p>
	      <!-- <p><span class="top">Description</span><br/>{{ form.content }}</p> -->
	      <p>Creator<br/>{{ form.creator }}
	      <p>Contact<br/>{{ form.contact }}
	      <p>Webpage URL<br/>{{ form.webpage }}
	      <p>Keywords (comma-separated) &#x02733;<br/>{{ form.keywords }}

	      <p>Public?:
	        {% if form.public.value == True %}
	          {{ form.public.value }}
	        {% else %}
	          <a href="#"><span class="help-matches" data-id="going_public_coll">
	            Making a collection public. {% fontawesome_icon 'question-circle' color='#336699' %}
	          </span></a>
	        {% endif %}
	      </p>
	      <tr>
	        <td class="my-0 small">&#x02733;<i><b> required</b></i></td>
	        <td></td>
	      </tr>
	      {% if action == 'update' and user.is_superuser or user.is_admin %}
	        <hr class="my-1"/>
		      <p class="rem1">Editor options
			      <a href="#" class="show-hide" style="">&#8595;</a></p>
		      <div id="editor_options" style="display: none">
			      <p>Featured rank: {{ form.featured }}</p>
			      <p>Image: {{ form.image_file }}</p>
		      </div>
	      {% endif %}
	      <!-- hidden multicheckboxselect; filled programmatically by js:listDataset()-->
	      <div id="select_div" class="hidden">{{ form.datasets }}</div>
	      <hr/>
	      <div id="collection_options"></div> <!-- collection_options -->
	      <p id="referrer"></p>
	      <input id="btn_coll_submit" class="btn-sm btn-primary mt-2" type="submit" value="Save" />
	      <!--<span title="back"><a href="{ url 'dashboard' %}">Cancel</a></span>-->
	      <span title="back"><a href="/mycollections">Cancel</a></span>
	    </form>
	    </div>
	    <div id="coll_builder" class="coll-col col-sm-4 p-2" style="height: 85%;">
				<ul id="coll_tabs" class="nav nav-tabs" role="tablist">
				  <li class="nav-item">
				    <a class="nav-link" id="coll_dslist-tab" data-toggle="tab" href="#coll_dslist" role="tab" aria-controls="coll_dslist" aria-selected="true" data-id="ds">Datasets</a>
				  </li>
				  <li class="nav-item">
				    <a class="nav-link active" id="coll_placelist-tab" data-toggle="tab" href="#coll_placelist" role="tab" aria-controls="coll_placelist" aria-selected="false" data-id="pl">Places ({{ coll_places|length }})</a>
				  </li>
				</ul>
		    <div class="tab-content" style="height:95%; overflow:auto;">
			    <div id="coll_dslist" class="tab-pane fade" role="tabpanel" aria-labelledby="coll_dslist-tab">
		        <p class="mt-2">
		        <span class="mr-2 smaller">
		          <select id="select_ds" name="ds" class="custom-select-sm">
		          <option value="0">Select dataset</option>
		          <option disabled>___________</option>
		          {% for ds in ds_select %}
		            {% if ds not in coll_dsset %}
		              <option value="{{ ds.id }}">{{ ds.title }}</option>
		            {% endif %}
		          {% endfor %}
		          </select>
		        </span>
		        <a href="javascript:{ addDataset() }" class="">
		          {% fontawesome_icon 'plus-square' color='#336699' %} add</a>
		      </p>
		        <!-- id, label, title, description, creator, create_date, webpage, numrows, datatype -->
		        <div id="coll_dscards_create">
			        {% if coll_dsset|length == 0 %}<p id="msg" class="font-italic smaller">None yet...</p>{% endif %}
			        {% for d in coll_dsset %}
			          <div class="ds_card">
			            <p class="mb-0"><a href="{% url 'datasets:ds_summary' id=d.id %}"><span class="ds_title">{{ d.title }}</span></a> <small>({{d.label}}/{{ d.id}})</small></p>
			            <div class="ds_fields">
			              <p class="my-1"><b>Description</b>: {{ d.description|truncatechars:150 }}</p>
			              <p class="my-1"><b>Create date</b>: {{ d.create_date|date:"d M Y" }}</p>
			              <p class="my-1"><b># rows</b>: {{ d.numrows }}

			              <a href="{% url 'collection:remove-ds' ds_id=d.id coll_id=object.id %}" class="float-right">{% fontawesome_icon 'minus-square' color='#336699' %} remove</a>
			              </p>
			            </div>
			          </div>
			        {% endfor %}
		        </div> <!-- #coll_dscards_create -->
			    </div>
			    <div id="coll_placelist" class="tab-pane fade show active" role="tabpanel" aria-labelledby="coll_placelist-tab">
				    {% if coll_places|length > 0 %}
		          <ul>
		            {% for p in coll_places %}
			            <li><a class="coll-place" data-id={{ p.id }} href="#" >{{ p.title }}</a> ({{ p.id }}) {{ p.ccodes }}</li>
		            {% endfor %}
		          </ul>
				    {% else %}
					    <p class="mb-0"><i>None yet</i></p>
				    {% endif %}
	        </div>
				</div> <!-- .tab-content -->
	    </div>
	    <div id="coll_right" class="coll-col col-sm-4 p-2" style="height: 85%;">
	      <div id="coll_right_intro" class="hidden">
		      <h5>Collections in WHG</h5>
		      <p>A <mark-b>collection</mark-b> is a set of existing WHG place records.</p>
		      <p>Registered users can build a collection by</p>
		      <ol class="mb-1 pl-4">
			      <li>Filling the required fields in the "Create" form</li>
			      <li>Adding one or more entire datasets for which they are the owner or a collaborator
				      <br/> <b class="red-bold">and/or</b></li>
			      <li>Adding individual place records from any public dataset, discovered by search or browsing</li>
		      </ol>
		      <p>Places added to a collection by either method (step #2 or step #3) appear in the list viewed under the "Places" tab.</p>
		      <p>Optionally, each place in a collection can be annotated with information about its membership in the collection: </p>
		      <ul class="mb-1 pl-4">
			      <li>associated dates or temporal order</li>
			      <li>one of the optional "relation tags" included in the collection metadata</li>
			      <li>a free-text description of the relation</li>
		      </ul>
		      <p>[<i>figure</i>]</p>
	      </div>
		    <div id="coll_right_anno" class="">
		      <h6>Annotations</h6>
			    <div id="coll_place_detail" class="mb-1"></div>
			    <div id="anno_detail" class="mb-1"></div>
{#		      <form id="annotation_form" method="POST" action="{% url 'collection:collection-annotate' object.id %}" enctype="multipart/form-data">#}
		      {% csrf_token %}
			    <div id="anno_div" class="mb-1 hidden">
				    <input type="hidden" name="collection" value="{{ object.id }}" placeholder="collection"/>
						<input id="pid" type="hidden" name="place" value="" placeholder="place (pid)"/>
						<p>Type: <span class="float-right"><input type="text" name="trace_type" value="event" placeholder="trace type"/></span></p>
						<p>Motivation: <span class="float-right"><input type="text" name="motivation" value="locating" placeholder="motivation"/></span></p>
{#						<p><input type="text" name="when" value="1832/1834" placeholder="year or start/end"/></p>#}
						<p>Start: <span class="float-right"><input type="text" name="start" value="1832" placeholder="start year"/></span></p>
						<p>End: <span class="float-right"><input type="text" name="end" value="1834" placeholder="end year(if applicable)"/></span></p>
{#						<p><input type="text" name="sequence" value="12" placeholder="sequence"/></p>#}
						<p>Relation: <span class="float-right"><input type="text" name="relation" value="waypoint" placeholder="relation"/></span></p>
			      <input type="submit" value="Save" />
			    </div>

{#			    <p>When {% fontawesome_icon 'question-circle' color='#336699' %}<br/>#}
{#				    <input type="text" placeholder="start date"  style="width:80px"/>#}
{#				    <input type="text" placeholder="end date" style="width:80px"/>#}
{#			    </p>#}
{#			    <p>Relation {% fontawesome_icon 'question-circle' color='#336699' %}<br/>#}
{#				    <select>#}
{#					    <option value="-1">Relation type</option>#}
{#					    <option value="0">Related locale</option>#}
{#					    <option value="1">Waypoint</option>#}
{#					    <option value="2">Battle site</option>#}
{#				    </select>#}
{#			      <p>Explanation:<br/><input type="textbox" /></p>#}
{#			    </p>#}
{#			    <p>Links: <a href="javascript:{ addDataset() }" class="">#}
{#	          {% fontawesome_icon 'plus-square' color='#336699' %} add</a>#}
{#				    <br/><a href="#">this page is related {% fontawesome_icon 'external-link' %}</a><br/>#}
{#			    </p>#}
		    </div>
	    </div>
    </div> <!-- d-flex -->
	  {# help modal div #}
		<div class="selector py-3"><div id="helpme"></div></div>
  {% endif %}
</div> <!-- container -->

<script type="text/javascript">
	// show/hide editor-restricted options
  $("#editor_options").hide();
	$('.show-hide').click(function(e) {
    $("#editor_options").slideToggle("fast");
    var val = $(this).html() == "↑" ? "↓" : "↑";
    {#var val = $(this).html() == "-" ? "+" : "-";#}
    $(this).hide().html(val).fadeIn("fast");
    {#$(this).hide().html(val).fadeIn("fast");#}
    e.preventDefault();
  });
  // builds link for external place record
  function url_extplace(identifier) {
    // abbreviate links not in aliases.base_urls
    if(identifier.startsWith('http')) {
      let tag = identifier.replace(/.+\/\/|www.|\..+/g, '')
      link = '<a href="'+identifier+'" target="_blank">'+tag+'{% fontawesome_icon 'external-link' color='#336699' %},  </a>'
    } else {
    link = '<a href="" class="ext" data-target="#ext_site">'+identifier+'{% fontawesome_icon 'external-link' color='#336699' %}</a>, '
    }
    return link
  }
  // builds link for external placetype record
  function url_exttype(type) {
      console.dir(type)
    link = ' <a href="#" class="exttab" data-id='+type.identifier+
      '>('+type.label.label+' {% fontawesome_icon "external-link" color="#336699" %})</a>'
    return link
  }
	// extent of timespan list
  function minmaxer(timespans){
    //console.log('got to minmax()',JSON.stringify(timespans))
    starts=[]; ends=[]
    for (t in timespans){
      // gets 'in', 'earliest' or 'latest'
      starts.push(Object.values(timespans[t].start)[0])
      ends.push(!!timespans[t].end ? Object.values(timespans[t].end)[0] : -1)
    }
    //console.log('starts',starts,'ends',ends)
    minmax=[Math.max.apply(null, starts),Math.max.apply(null, ends)]
    return minmax
  }

  // return html for display
  function parsePlace(data) {
    window.featdata = data
    function onlyUnique(array) {
      const map = new Map();
      const result = [];
      for (const item of array) {
        if(!map.has(item.identifier)){
            map.set(item.identifier, true);
            result.push({
                identifier: item.identifier,
                type: item.type,
                aug: item.aug
            });
        }
      }
      return(result)
    }
    // TITLE
    descrip = '<p><b>Title</b>: <span id="row_title" class="larger text-danger">'+data.title+'</span>'
    // NAME VARIANTS
    descrip+='<p class="scroll65"><b>Variants</b>: '
    for (n in data.names) {
      let name = data.names[n]
      descrip+= '<p>'+name.toponym !=''?name.toponym+'; ': ''
    }
    // TYPES
    // may include sourceLabel:"" **OR** sourceLabels[{"label":"","lang":""},...]
    // console.log('data.types',data.types)
    //{"label":"","identifier":"aat:___","sourceLabels":[{"label":" ","lang":"en"}]}
    descrip+='</p><p><b>Types</b>: '
    typeids = ''
    for (t in data.types) {
      str = ''
      var type = data.types[t]
      console.log('type',type)
      if('sourceLabels' in type){
        srclabels = type.sourceLabels
        for(l in srclabels){
          label = srclabels[l]['label']
          str = label !='' ? label + '; ' : ''
        }
      } else if ('sourceLabel' in type) {
        str = type.sourceLabel !='' ? type.sourceLabel + '; ' : ''
      }
      if(type.label!=''){
        str += url_exttype(type) + ' '
      }
      typeids+=str
    }
    descrip += typeids.replace(/(; $)/g, "") +'</p>'

    // LINKS
    //
    descrip += '<p class="mb-0"><b>Links</b>: <i>original: </i>'
    close_count = added_count = related_count = 0
    html_close = html_added = html_related = ''
    if (data.links.length > 0) {
      links=data.links
      links_arr = onlyUnique(data.links)
      console.log('distinct data.links',links_arr)
      for (l in links_arr) {
        //console.log('link',links_arr[l])
        if (links_arr[l].aug == true) {
          added_count +=1
          html_added += url_extplace(links_arr[l].identifier)
        } else {
          close_count +=1
          html_close+=url_extplace(links_arr[l].identifier)
        }
      }
      descrip += close_count > 0 ? html_close : 'none; '
      descrip += added_count > 0 ? '<i>added</i>: '+html_added : '<i>added</i>: none'
    } else { descrip += "<i class='small'>no links established yet</i>" }
    descrip += '</p>'

    // RELATED
    //right=''
    if (data.related.length > 0) {
      parent='<p class="mb-0"><b>Parent(s)</b>: ';
      related='<p class="mb-0"><b>Related</b>: ';
      for (r in data.related){
        rel = data.related[r]
        //console.log('rel',rel)
        if (rel.relation_type == 'gvp:broaderPartitive'){
          parent += '<span class="h1em">'+rel.label
          parent += 'when' in rel && !('timespans' in rel.when) ?
            ', '+rel.when.start.in+'-'+rel.when.end.in :
            'when' in rel && ('timespans' in rel.when) ? ', '+
              minmaxer(rel.when.timespans) : ''
              //rel.when.timespans : ''
          parent += '</span>; '
        }
        else {
          related += '<p class="small h1em">'+rel.label+ ', '+rel.when.start.in+'-'+rel.when.end.in+'</p>'
        }
      }
      descrip+=parent.length > 39 ? parent :''
      descrip+=related.length > 37 ? related :''
    }

    // DESCRIPTIONS
    // TODO: link description to identifier URI if present
    if (data.descriptions.length > 0) {
      val = data.descriptions[0]['value'].substring(0,300)
      descrip+='<p><b>Description</b>: '+(val.startsWith('http')?'<a href="'+val+'" target="_blank">Link</a>':val)
        +' ... </p>'
        //'<br/><span class="small red-bold">('+data.descriptions[0]['identifier']+')</span>
    }

    // CCODES
    //
    //if (data.ccodes.length > 0) {
    if (!!data.countries) {
      //console.log('data.countries',data.countries)
      descrip+='<p><b>Modern country bounds</b>: '+ data.countries.join(', ')+'</p>'
    }

    // MINMAX
    //
    //console.log('data.minmax',data.minmax)
    mm=data.minmax
    if(data.minmax && !(mm[0] == null && mm[1] == null)) {
      descrip += '<p><b>When</b>: earliest: '+data.minmax[0]+'; latest: '+data.minmax[1]
    }

    // TRACES)
	  traces=JSON.parse(data.traces)
	  console.log('traces.length', traces.length)
	  if(traces.length == 0){
      // no annotations yet, make form visible
		  $("#anno_detail").hide()
      $("#anno_div").fadeIn()
	  } else {
	    $("#anno_detail").html('<p><b>Trace annotation</b>: '+traces[0].fields+'</p>')
	  }

    // if geom(s) and 'certainty', add it
    if(data.geoms.length >0){
      cert = data.geoms[0].certainty
      if(cert != undefined ){
        descrip += '<p><b>Location certainty</b>: '+cert+'</p>'
      }
    }
    descrip += '</div>'
    return descrip
  }
	// fetch place to be annotated
  function getPlace(pid){
    //console.log('getPlace()', pid)
    $.ajax({
      url: "/api/place/"+pid,
      }).done(function( data ) {
        console.log('place data', data)
        $("#coll_place_detail").html(parsePlace(data))
        {#spinner_detail.stop()#}
        // events on detail items
        $('.ext').on('click', function(e) {
          e.preventDefault();
          str=$(this).text()
          //console.log('str (identifier)',str)
          // URL identifiers can be 'http*' or an authority prefix
          if(str.substring(0,4).toLowerCase() == 'http'){
            url = str
          } else {
            var re = /(http|bnf|cerl|dbp|gn|gnd|gov|loc|pl|tgn|viaf|wd|wdlocal|whg|wp):(.*?)$/;
            url=base_urls[str.match(re)[1]]+str.match(re)[2]
            console.log('getPlace() url', url, encodeURI(url))
          }
          window.open(url, '_blank');
          // window.open(encodeURI(url), '_blank');
        });
        $('.exttab').on('click', function(e) {
          e.preventDefault();
          id=$(this).data('id').toString()
          console.log('id',id)
          var re = /(http|dbp|gn|tgn|wd|loc|viaf|aat):(.*?)$/;
          url=id.match(re)[1]=='http' ? id : base_urls[id.match(re)[1]]+id.match(re)[2]
          console.log('url',url)
          window.open(url,'_blank')
        });
    });
    //spinner_detail.stop()
  }

  $(function(){
		console.log('pid', "{{ pid }}")
    $(".coll-place").click(function(){
        console.log('fetch r/o place record', $(this).data('id'));
        getPlace($(this).data('id'))
		    $("#pid").val($(this).data('id'))
    })
		{#$("coll-place").click(function(){#}
			{#e.preventDefault()#}
		{#	console.log('fetch r/o place record', $(this).data('id'))#}

    $(".nav-link").click(function(){
			  var tab = $(this).data('id')
			  console.log(tab)
			  if(tab == 'ds'){
					  $("#coll_right_anno").addClass('hidden')
					  $("#coll_right_intro").removeClass('hidden')
			  } else {
					  $("#coll_right_anno").removeClass('hidden')
					  $("#coll_right_intro").addClass('hidden')
			  }
	  })

    dslist=[]
    $( ".textarea" ).each(function(index) {
      if ( ["None","null"].includes( $(this).val() ) ) {
        $(this).val('')
      }
    });

    $("#id_geojson").attr("placeholder","generated from country codes")

    // help modals
    $(".help-matches").click(function(){
      page=$(this).data('id')
      console.log('help:', page)
      $('.selector').dialog('open');
    })
    $(".selector").dialog({
      resizable: false,
      autoOpen: false,
      height: $(window).height() * 0.9,
      width: $(window).width() * 0.8,
      title: "WHG Help",
      modal: true,
      buttons: { 'Close': function() {console.log('close dialog'); $(this).dialog('close');} },
      open: function(event, ui) {
        $('#helpme').load('/media/help/'+page+'.html')
      },
      show: {effect: "fade",duration: 400 },
      hide: {effect: "fade",duration: 400 }
    });
  })

  // at least two datasets selected?
  {#$("#btn_coll_submit").click(function(e){#}
  {#  if('{{action}}' == 'create' && dslist.length < 2) {#}
  {#    e.preventDefault()#}
  {#    $("#msg").html('<h6>Collections must contain at least 2 datasets!</h6>').addClass('strong-red').show()#}
  {#  }#}

  function listDataset(d) {
    console.log('listing this:', d.title)
    dslist.push(d.id)
    $("#id_datasets [value=" + d.id + "]").attr("checked", "checked");
    card='<div class="ds_card" id="card_'+d.id+'">'
        +'<p class="mb-0"><a href="#"><span class="ds_title">'+d.title+'</span></a> ('+d.label+'/'+d.id+')</p>'
        +'<div class="ds_fields">'
          +'<p class="my-1"><b>Description</b>: '+d.description+'</p>'
          +'<p class="my-1"><b>Create date</b>: '+d.create_date+'</p>'
          +'<p class="my-1"><b># rows</b>: '+d.numrows
            +'<a href="javascript:{ removeDataset('+d.id+') }" class="float-right">'
              +'{% fontawesome_icon "minus-square" color="#336699" %} remove</a>'
          +'</p></div></div>'
    $("#coll_dscards_create").append(card)
    // console.log(card)
  }
  // adds, displays single dataset
  function addDataset() {
    console.log('selected', $("#select_ds").val())
    $.get("/collections/list_ds", {ds_id:$("#select_ds").val()},
      function(data){
        // render to html
        listDataset(data)
        console.log('ds to list:',data)
        // append ds.id to form
    });
    // reset select
    $("#select_ds").val(0)
    $("#msg").html('').hide()
  }
  function clearDataset(dsid){
    console.log('clear card for ds', dsid)
    $("#card_"+dsid).remove()
  }
  function removeDataset(dsid) {
    if("{{ action }}" == 'update') {
      console.log('removing ' + dsid + 'from collection '+ "{{object.id}}")
      $.ajax("/collections/remove_ds/{{object.id}}/"+dsid,
        function(result){
          console.log('removeDataset() result', result)
      });
    } else {
      $("#id_datasets [value=" + dsid + "]").prop("checked", false);
      let idx = dslist.indexOf(dsid)
      dslist.splice(idx, dslist.length);
      card = "#card_"+dsid
      $(card).remove()
      if(dslist.length == 0 ){ $("#msg").html('None yet...').show()}
      console.log('removed '+dsid+' from dslist[] and dom')
    }
    // reset select
    $("#select_ds").val(0)
  }
</script>

{% endblock %}


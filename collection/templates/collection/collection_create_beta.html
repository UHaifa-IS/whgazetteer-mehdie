<!-- collection/collection_create_beta.html -->
{% extends "main/base.html" %}
{% load leaflet_tags %}
{% load fontawesome %}
{% load static %}
{% load dataset_extras %}
{% block title %}<title>WHG::Create/Update Collection (beta)</title>{% endblock %}
{% block extra_head %}
  {% leaflet_js %}
  {% leaflet_css %}
  
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.css' rel='stylesheet' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.js'></script>
  <script src="{% static 'js/leaflet-mapbox-gl.js' %}"></script>

  <style>
    .coll-col { border-right: 1px dashed lightgray;;}
  </style>
{% endblock %}

{% block content %}
<div class="container container-md" style="height: calc(100vh - 65px);">
  <!--owner or superuser: {{user.id}} {{object.owner.id}}-->
  {% if action == 'update' and user.id != object.owner.id %}
    <p>Access to this page is limited to the collection owner(s). object: {{object.owner.id}}</p>
  {% else %}
  <h4 class="mt-3">
    {% if action == 'update' %}Update Collection: <span class="text-danger">"{{ form.title.value }}"</span>
    <a href="{% url 'collection:collection-delete' object.id %}" class="float-right"
      title="Delete collection" rel="tooltip" style="margin-top:-2px;">
      {% fontawesome_icon 'trash' color='#336699' %}</a>
    {% else %}Create Collection{% endif %} <span class="red-head"> (beta)</span>
  </h4>
  <div class="d-flex h-100">
    <div id="coll_form" class="form-box mt-2 col-sm-4">
      <form id="collection_form" method="POST" action="#" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="owner" value='{{ user.id }}'></input>
      <p>Title &#x02733;<br/>{{ form.title }}</p>
      <p><span class="top">Description &#x02733;</span><br/>{{ form.description }}</p>
      <!-- <p><span class="top">Description</span><br/>{{ form.content }}</p> -->
      <p>Creator<br/>{{ form.creator }}
      <p>Contact<br/>{{ form.contact }}
      <p>Webpage URL<br/>{{ form.webpage }}
      <p>Keywords (comma-separated) &#x02733;<br/>{{ form.keywords }}

      <p>Public?:
        {% if form.public.value == True %}
          {{ form.public.value }}
        {% else %}
          <a href="#"><span class="help-matches" data-id="going_public_coll">
            Making a collection public. {% fontawesome_icon 'question-circle' color='#336699' %}
          </span></a>
        {% endif %}
      </p>
      <tr>
        <td class="my-0 small">&#x02733;<i><b> required</b></i></td>
        <td></td>
      </tr>
      {% if action == 'update' %}
        <p>Create date: {{ create_date }}</p>
      {% endif %}
      {% if action == 'update' and user.is_superuser or user.is_admin %}
        <hr class="my-1"/>
	      <p class="rem1">Editor options
		      <a href="#" class="show-hide" style="">&#8595;</a></p>
	      <div id="editor_options" style="display: none">
		      <p>Featured rank: {{ form.featured }}</p>
		      <p>Image: {{ form.image_file }}</p>
	      </div>
      {% endif %}
      <!-- hidden multicheckboxselect; filled programmatically by js:listDataset()-->
      <div id="select_div" class="hidden">{{ form.datasets }}</div>
      <hr/>
      <div id="collection_options"></div> <!-- collection_options -->
      <p id="referrer"></p>
      <input id="btn_coll_submit" class="btn-sm btn-primary mt-2" type="submit" value="Save" />
      <!--<span title="back"><a href="{ url 'dashboard' %}">Cancel</a></span>-->
      <span title="back"><a href="/dashboard#collectionlist">Cancel</a></span>
    </form>
    </div>
    <div id="coll_builder" class="coll-col col-sm-4 p-2" style="height: 85%;">
			<ul id="api_tabs" class="nav nav-tabs" role="tablist">
			  <li class="nav-item">
			    <a class="nav-link" id="coll_dslist-tab" data-toggle="tab" href="#coll_dslist" role="tab" aria-controls="coll_dslist" aria-selected="true" data-id="ds">Datasets</a>
			  </li>
			  <li class="nav-item">
			    <a class="nav-link active" id="coll_placelist-tab" data-toggle="tab" href="#coll_placelist" role="tab" aria-controls="coll_placelist" aria-selected="false" data-id="pl">Places</a>
			  </li>
			</ul>
	    <div class="tab-content" style="height:95%; overflow:auto;">
		    <div id="coll_dslist" class="tab-pane fade" role="tabpanel" aria-labelledby="coll_dslist-tab">
	        <p class="mt-2">
	        <span class="mr-2">
	          <select id="select_ds" name="ds" class="custom-select-sm" style="width:auto; min-width:150px;">
	          <option value="0">Select dataset</option>
	          <option disabled>___________</option>
	          {% for ds in ds_select %}
	            {% if ds not in coll_dsset %}
	              <option value="{{ ds.id }}">{{ ds.title }}</option>
	            {% endif %}
	          {% endfor %}
	          </select>
	        </span>
	        <a href="javascript:{ addDataset() }" class="">
	          {% fontawesome_icon 'plus-square' color='#336699' %} add</a>
	      </p>
	        <!-- id, label, title, description, creator, create_date, webpage, numrows, datatype -->
	        <div id="coll_dscards_create">
		        {% if coll_dsset|length == 0 %}<p id="msg" class="font-italic smaller">None yet...</p>{% endif %}
		        {% for d in coll_dsset %}
		          <div class="ds_card">
		            <p class="mb-0"><a href="{% url 'datasets:ds_summary' id=d.id %}"><span class="ds_title">{{ d.title }}</span></a> <small>({{d.label}}/{{ d.id}})</small></p>
		            <div class="ds_fields">
		              <p class="my-1"><b>Description</b>: {{ d.description|truncatechars:150 }}</p>
		              <p class="my-1"><b>Create date</b>: {{ d.create_date|date:"d M Y" }}</p>
		              <p class="my-1"><b># rows</b>: {{ d.numrows }}

		              <a href="{% url 'collection:remove-ds' ds_id=d.id coll_id=object.id %}" class="float-right">{% fontawesome_icon 'minus-square' color='#336699' %} remove</a>
		              </p>
		            </div>
		          </div>
		        {% endfor %}
	        </div> <!-- #coll_dscards_create -->
		    </div>
		    <div id="coll_placelist" class="tab-pane fade show active" role="tabpanel" aria-labelledby="coll_placelist-tab">
			    <p class="mb-0"><i>Place records from collection datasets</i></p>
          <ul>
            {% for p in coll_places %}
	            <li><a href="#" >{{ p.title }}</a> ({{ p.id }}) {{ p.ccodes }}</li>
            {% endfor %}
          </ul>
        </div>
			</div> <!-- .tab-content -->
    </div>
    <div id="coll_right" class="coll-col col-sm-4 p-2" style="height: 85%;">
      <div id="coll_right_intro" class="hidden">
	      <h6>Collections in WHG</h6>
	      <p>What you need to know...</p>
	      <p>Replaced by place-collection annotations for Places tab</p>
      </div>
	    <div id="coll_right_anno" class="" style="padding-top:38px;">
	      <h6>Annotations</h6>
					<p class="larger red-bold"><b>Lambert Bay</b></p>
			    <p>When {% fontawesome_icon 'question-circle' color='#336699' %}<br/>
				    <input type="text" placeholder="start date"  style="width:80px"/>
				    <input type="text" placeholder="end date" style="width:80px"/></p>
			    <p>Relation {% fontawesome_icon 'question-circle' color='#336699' %}<br/>
				    <select>
					    <option value="-1">Relation type</option>
					    <option value="0">Related locale</option>
					    <option value="1">Waypoint</option>
					    <option value="2">Battle site</option>
				    </select>
			    <p>Explanation:<br/><input type="textbox" /></p>
			    </p>
			    <p>Links: <a href="javascript:{ addDataset() }" class="">
	          {% fontawesome_icon 'plus-square' color='#336699' %} add</a>
				    <br/><a href="#">this page is related {% fontawesome_icon 'external-link' %}</a><br/>
				    <!--<input type="text">-->
			    </p>
			    <input type="submit" value="Save" />
		    </div>
	    </div>
    </div>
  </div> <!-- d-flex -->
  <div class="selector py-3"><div id="helpme"></div></div>
  {% endif %}
</div> <!-- container -->

<script type="text/javascript">
  $("#editor_options").hide();

  $('.show-hide').click(function(e) {
    $("#editor_options").slideToggle("fast");
    var val = $(this).html() == "↑" ? "↓" : "↑";
    {#var val = $(this).html() == "-" ? "+" : "-";#}
    $(this).hide().html(val).fadeIn("fast");
    {#$(this).hide().html(val).fadeIn("fast");#}
    e.preventDefault();
  });

  $(function(){
	  $(".nav-link").click(function(){
			  var tab = $(this).data('id')
			  console.log(tab)
			  if(tab == 'ds'){
					  $("#coll_right_anno").addClass('hidden')
					  $("#coll_right_intro").removeClass('hidden')
			  } else {
					  $("#coll_right_anno").removeClass('hidden')
					  $("#coll_right_intro").addClass('hidden')
			  }
	  })
    dslist=[]
    $( ".textarea" ).each(function(index) {
      if ( ["None","null"].includes( $(this).val() ) ) {
        $(this).val('')
      }
    });

    $("#id_geojson").attr("placeholder","generated from country codes")

    // help modals
    $(".help-matches").click(function(){
      page=$(this).data('id')
      console.log('help:', page)
      $('.selector').dialog('open');
    })
    $(".selector").dialog({
      resizable: false,
      autoOpen: false,
      height: $(window).height() * 0.9,
      width: $(window).width() * 0.8,
      title: "WHG Help",
      modal: true,
      buttons: { 'Close': function() {console.log('close dialog'); $(this).dialog('close');} },
      open: function(event, ui) {
        $('#helpme').load('/media/help/'+page+'.html')
      },
      show: {effect: "fade",duration: 400 },
      hide: {effect: "fade",duration: 400 }
    });
  })
  
  $("#btn_coll_submit").click(function(e){
    // at least two datasets selected?
    if('{{action}}' == 'create' && dslist.length < 2) {
      e.preventDefault()
      $("#msg").html('<h6>Collections must contain at least 2 datasets!</h6>').addClass('strong-red').show()
    }
  })
  function listDataset(d) {
    console.log('listing this:', d.title)
    dslist.push(d.id)
    $("#id_datasets [value=" + d.id + "]").attr("checked", "checked");
    card='<div class="ds_card" id="card_'+d.id+'">'
        +'<p class="mb-0"><a href="#"><span class="ds_title">'+d.title+'</span></a> ('+d.label+'/'+d.id+')</p>'
        +'<div class="ds_fields">'
          +'<p class="my-1"><b>Description</b>: '+d.description+'</p>'
          +'<p class="my-1"><b>Create date</b>: '+d.create_date+'</p>'
          +'<p class="my-1"><b># rows</b>: '+d.numrows
            +'<a href="javascript:{ removeDataset('+d.id+') }" class="float-right">'
              +'{% fontawesome_icon "minus-square" color="#336699" %} remove</a>'
          +'</p></div></div>'
    $("#coll_dscards_create").append(card)
    // console.log(card)
  }
  // adds, displays single dataset
  function addDataset() {
    console.log('selected', $("#select_ds").val())
    $.get("/collections/list_ds", {ds_id:$("#select_ds").val()},
      function(data){
        // render to html
        listDataset(data)
        console.log('ds to list:',data)
        // append ds.id to form
    });
    // reset select
    $("#select_ds").val(0)
    $("#msg").html('').hide()
  }
  function clearDataset(dsid){
    console.log('clear card for ds', dsid)
    $("#card_"+dsid).remove()
  }
  function removeDataset(dsid) {
    if("{{ action }}" == 'update') {
      console.log('removing ' + dsid + 'from collection '+ "{{object.id}}")
      $.ajax("/collections/remove_ds/{{object.id}}/"+dsid,
        function(result){
          console.log('removeDataset() result', result)
      });
    } else {
      $("#id_datasets [value=" + dsid + "]").prop("checked", false);
      let idx = dslist.indexOf(dsid)
      dslist.splice(idx, dslist.length);
      card = "#card_"+dsid
      $(card).remove()
      if(dslist.length == 0 ){ $("#msg").html('None yet...').show()}
      console.log('removed '+dsid+' from dslist[] and dom')
    }
    // reset select
    $("#select_ds").val(0)
  }
</script>

{% endblock %}


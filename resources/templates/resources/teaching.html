{% extends "main/base.html" %}
{% block title %}<title>WHG::Teaching</title>{% endblock %}

{% block content %}
	{% load fontawesome %}
	{% load geojson_tags %}
	{% load leaflet_tags %}
	{% load static %}
	{% load dataset_extras %}
	{% block extra_head %}
	<style>
		#teaching_essay {height: 85%; overflow: auto; }
		#essay_modal {font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
			font-size: 1.2rem;}
		#main {
      position: relative;
      border: 1px solid black;
      border-radius: 8px;
      /* height: 100%; */
      width: 100%;
			overflow:hidden;
    }
		.leaflet-container, .leaflet-container-default {min-height: 220px !important; max-height: 230px !important;}
		/* .leaflet-container-default {height: 250px !important;} */
		.fill-grey {background-color:gainsboro; }
		.resource-gallery {background-color:rgb(238, 238, 238); overflow:auto;}
		.fill-blue {background-color:rgb(60, 136, 148); }
		.gallery-banner {border-bottom: 1px solid lightgray; 
			background-color:rgb(60, 136, 148); color: white;}
		.regions-ttlink {color:grey; font-size:.75rem; float:right; text-decoration-line: underline;}
		.reset-link {float:right; display:none; color:white; text-decoration-line: underline;}
		#region_label {font-family: 'Raleway', sans-serif !important; font-size:1rem; color: tomato;}
		#teaching_bottom {height:65%;}
		#teaching_top {height:230px;}
		.teaching-essay {outline: rgb(60, 136, 148) 1px solid; box-shadow: 4px 4px rgb(221, 221, 221);
			border-radius: 4px; background-color: ivory; min-height:auto; overflow-y: auto;}
		.resource-card {float:left; margin-right:.1rem; 
			width: 33%; height: 180px; overflow-y:auto; background-color: white;}
		.resource-card:hover {cursor: pointer; opacity:0.8;}
		.resource-card-header {width:100%; background-color: honeydew;}
		.resource-card-content h6 {font-size: .9rem;}
		.resource-card-blurb {line-height: 1rem; font-size: small;}
	</style>
	{% leaflet_js %}
	{% leaflet_css %}
	{% endblock %}

	<div class="container pt-2 container-md" style="height: calc(100vh - 65px); ">
		<section class="text-center">
			<div class="container mb-1">
				<h3>Teaching with World Historical Gazetteer</h3>
			</div>
		</section>
		<div id="teaching_top" class="row">
			<!-- <div class="container"> -->
				<div class="row">
					<div class="col-md-7">{% lorem 75 w random%}</div>
					<div class="col-md-5">{% leaflet_map "main" %}</div>
				</div>
			<!-- </div> -->
		</div> <!-- .row -->
		<div id="teaching_bottom" class="row mt-2">
			<div class="col-sm-4 px-0" style="height: 80%;">
				<div class="teaching-essay p-2">
					<div id="">
					<h5 class="mb-0">Place in World History</h5>
					<p class="font-italic my-1">Ruth Mostern</p>
					<p>Spatial humanists and others have long recognized the enormous integrative potential of using place as common point of
					reference for heterogeneous information. Given that the names and attributes of places vary over time and between
					communities, and often in the context of conquest and oppression, ambitious development of linked, diverse, and
					multilingual gazetteers is absolutely vital. 
					<span class="modal-link" data-id="essay_rm"><a href="#" >more...</a></span></p>
					</div>
				</div>
			</div>
			<div class="col-sm-8 pr-0" style="height: 80%;">
				<div class="resource-gallery h-100">
					<div class="gallery-banner pl-2 small w-100";>
						TEACHING RESOURCES 
						<span id="regions_reset" class="reset-link mr-2" style="cursor:pointer;">reset filter</span>
					</div>
					<div class="pl-1">
						{% for r in resource_list %}
						<div class="resource-card mt-1" data-regions="{{r.regions}}">
							<div class="resource-card-header pl-2 small ">{{ r.type }}
								<span class="regions-ttlink mr-1" data-toggle="tooltip" data-html="true" title="{{r.regions}}">
									{% fontawesome_icon 'globe' %} regions</span>
								{%comment%}<i>{{r.regions}}</i>{%endcomment%}
							</div>
							<div class="resource-card-content px-2 pt-1" data-id={{r.id}}>
								{% with remainder=190|add:r.title_length %}
								<h6><a href="{% url 'resources:resource-detail' r.id %}">{{ r.title }}</a></h6>
								<p class="resource-card-blurb my-1">{{ r.description|trunc_it:remainder }} </p>
								<!-- <i>{{r.description|length}} chars </i> -->
								{%endwith%}
							</div>
						</div>
						</a>
						{% endfor %}
					</div>
				</div>
			</div>
		</div>
		<div id="essay_modal" class="selector py-3" style="font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;"></div>
	</div>
	<script type="text/javascript">
		$(function () {
			$('[data-toggle="tooltip"]').tooltip()
			$("#regions_reset").click(function(){
				resetRegions()
			})
		})

		function resetRegions(){
			regions.setStyle({ fillColor: "#ff9999", color: "black" })
			$('.resource-card').css('display', 'block')
			$("#regions_reset").hide();
		}
		function filterResources(region){
			var $el = $('.resource-card').filter(function () {
				// console.log('this', $(this).data("regions"))
				return (!$(this).data("regions").includes(region))
			}).css('display','none')
			shown = $('.resource-card').filter(function(){
				return $(this).is(":visible");
			}) 
			regiones = []
			shown.each(function(){
				regarr = $(this).attr('data-regions').split(', ')
				// console.log('regset',regarr, typeof(regarr))
				regiones.push(regarr)
			})
			merged = [].concat.apply([], regiones);
			unique = [...new Set(merged.map(item => item))];
			$("#regions_reset").show();
		}

		// var dataurl = '{% url "area-features" %}';
		var dataurl = 'http://localhost:8000/api/area_features?filter=un';

		styles = {
				"MultiPolygon": {
					"default": { fillOpacity: 0.3, opacity: 1, color: "#000", weight: 1, fillColor: "#ff9999" },
					"focus": { fillOpacity: 0.3, opacity: 1, color: "red", weight: 2, fillColor: "#ff9999" }
				},
				"Polygon": {
					"default": { fillOpacity: 0.3, opacity: .5, color: "#666", weight: 1, fillColor: "#ff9999" },
					"focus": { fillOpacity: 0.3, opacity: .5, color: "red", weight: 2, fillColor: "#ff9999" }
				}
			}

		window.addEventListener("map:init", function (event) {
			map = event.detail.map;
			L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(map);

			
			fetch(dataurl)
				.then(function (resp) {
					return resp.json();
				})
				.then(function (data) {
					// console.log(data)
					idToFeature = {}
					regions = L.geoJson(data, {
						filter: function (feature, layer) {
							return "{{ regions }}".includes(feature.properties.id);
						},
						onEachFeature: function onEachFeature(feature, layer) {
							// console.log('feature:', feature)
							identifier = feature.properties.id;
							layer.setStyle({ fillOpacity: .1, opacity: .5, color: "#000", weight: 1, fillColor: "#ff9999" })
							var props = feature.properties;
							// var content = `<b>${props.title}</b><p>${props.description}</p>`;
							var content = `<b>${props.title}</b>`;
							idToFeature[identifier] = layer
							// layer.bindPopup(content);
							layer.on('mouseover', function (e) {
								$("#region_label").html(content);
							});
							layer.on('mouseout', function (e) {
								$("#region_label").html("select region to filter")
							});							
							// layer.bindPopup(content);
						}
					}).addTo(map);
					
					L.Control.textbox = L.Control.extend({
						onAdd: function (map) {

							var textdiv = L.DomUtil.create('div');
							textdiv.id = "region_label";
							textdiv.innerHTML = "select region to filter"
							return textdiv;
						},

						onRemove: function (map) {
							// Nothing to do here
						}
					});
					L.control.textbox = function (opts) { return new L.Control.textbox(opts); }
					L.control.textbox({ position: 'topright' }).addTo(map);

					regions.on('click', function(e){
						// console.log('layer', e.layer)
						// show title in upper right
						$("#region_label").html(e.layer.feature.properties.title)
						// display all cards
						$('.resource-card').css('display', 'block')
						// default fill and outline for all regions
						regions.setStyle({fillColor:"#ff9999", color:"black"})
						// set fill for this to yellow
						e.layer.setStyle({fillColor:'yellow', color:"red"})
						// filter cards on region
						filterResources(e.layer.feature.properties.title)
						// title=e.layer.feature.properties.title
						// console.log('clicked region:',title)
					})
				});
		});
		$(function () {})
		// resources
		$(".resource-card-content").click(function(){
			rid = $(this).data('id');
			window.location.href = "/resources/"+rid+"/detail";
		})
		$(".modal-link").click(function () {
			page = $(this).data('id')
			$('.selector').dialog('open');
		})
		$(".selector").dialog({
				resizable: true,
				autoOpen: false,
				width: $(window).width() * 0.5,
				height: $(window).height() * 0.9,
				title: "Teaching with World Historical Gazetteer",
				modal: true,
				buttons: {
					'Close': function () {
						$(this).dialog('close');
					}
				},
				open: function (event, ui) {
					$('.selector').load('/media/resources/'+page+'.html');
				},
				show: { effect: "fade", duration: 400 },
				hide: { effect: "fade", duration: 400 }
			});

	</script>
{% endblock %}


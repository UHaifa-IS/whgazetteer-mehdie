{% extends "main/base.html" %}
{% load static %}
{% load leaflet_tags %}
{% load fontawesome %}
{% load mathfilters %}
{% load dataset_extras %}
{% block extra_head %}
  {% leaflet_js %}
  {% leaflet_css %}
  <script src="{% static 'js/aliases.js' %}"></script>
  <script src="{% static 'js/easyprint.js' %}"></script>
  <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
  <script src="{% static 'js/spin.umd.js' %}"></script>
  <link rel="stylesheet" href="{% static 'css/spin.css' %}"/>
  <link rel="stylesheet" href="//cdn.datatables.net/1.10.16/css/dataTables.bootstrap4.min.css">
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.css' rel='stylesheet' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.js'></script>
  <script src="{% static 'js/leaflet-mapbox-gl.js' %}"></script>
{% endblock %}
{% block title %}<title>Dataset::{{ ds.label }}</title>{% endblock %}
{% block content %}
<div id="dataset_content" class="container mt-1 px-1">
  <ul id="dataset_tabs" class="nav nav-tabs" role="tablist">
    <span class="ds-title ml-1 mr-3">{{ ds.title }}</span>
    <li class="nav-item">
      <a class="nav-link active" id="summary-tab" data-toggle="tab" href="#summary" role="tab" aria-controls="summary" aria-selected="true">Metadata</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="browse-tab" data-toggle="tab" href="#browse" role="tab" aria-controls="browse" aria-selected="false">Browse</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="reconciliation-tab" data-toggle="tab" href="#reconciliation" role="tab" aria-controls="reconciliation" aria-selected="false">Reconciliation</a>
    </li>
    <li id="addtask_li" class="nav-item hidden">
      <a class="nav-link" id="addtask-tab" data-toggle="tab" href="#addtask" role="tab" aria-controls="addtask" aria-selected="false">Add task</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="sharing-tab" data-toggle="tab" href="#sharing" role="tab" aria-controls="sharing" aria-selected="false">Sharing</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="log-tab" data-toggle="tab" href="#log" role="tab" aria-controls="log" aria-selected="false">Log & Comments</a>
    </li>
  </ul>
  <!-- Tab panes -->
  <div class="tab-content">
    <div id="summary" class="tab-pane fade show active" role="tabpanel" aria-labelledby="summary-tab">
      <form id="ds_form" method="POST" action="#" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="row">
      <div id="ds_details" class="col-sm-8 small">
      {% if object.owner.id == user.id or user.is_superuser %}
        <span class="float-right">
          Delete dataset <a href="{% url 'datasets:dataset-delete' ds.id %}" class="" title="Delete dataset" rel="tooltip">{% fontawesome_icon 'trash' color='#ff0000' %}</a></span>
      {% endif %}
        <table class="ds-table">
          <tr>
            <td><b>ID / label</b></td>
            <td>{{ ds.id }} / {{ ds.label }}</td>
          </tr>
          <tr>
            <td><b>Title</b> 
              <a href="#" class="edit-title">{% fontawesome_icon 'edit' color='#336699' %}</a>
            </td>
            <td>
              <span class="form-title bigger strong">{{ form.title.value }}
                {% if ds.webpage %}(<a href="{{ ds.webpage }}" target="_blank">webpage</a> <a href="#" class="edit-webpage">{% fontawesome_icon 'edit' color='#336699' %}</a>){% endif %}
              </span>
              <span class="hidden editing-title">{{ form.title }}</span>&nbsp;
              <span class="hidden editing-webpage">{{ form.webpage }}</span>&nbsp;
            </td>
          </tr>
          <tr>
            <td><b>URI base</b>
              <a href="#" class="edit-uri_base">{% fontawesome_icon 'edit' color='#336699' %}</a>
            </td>
            <td>
              <span class="form-uri_base">{{ form.uri_base.value }}</span>
              <span class="hidden editing-uri_base">{{ form.uri_base }}</span>
            </td>
          </tr>
          <!--<tr>-->
            <!--<td><b>Web page</b>-->
              <!--<a href="#" class="edit-webpage">{ fontawesome_icon 'edit' color='#336699' %}</a>-->
            <!--</td>-->
            <!--<td>-->
              <!--<span class="form-webpage">{{ form.webpage.value }}</span>-->
              <!--<span class="hidden editing-webpage">{{ form.webpage }}</span>-->
            <!--</td>-->
          <!--</tr>-->
          <tr>
            <td style="vertical-align:top;"><b>Description</b> 
              <a href="#" class="edit-description">{% fontawesome_icon 'edit' color='#336699' %}</a>
            </td>
            <td>
              <span class="form-description">{{ form.description.value }}</span>
              <span class="hidden editing-description">{{ form.description }}</span>
            </td>
          </tr>
          <tr>
            <td style="vertical-align:top;"><b>Public?</b> 
              <a href="#" class="edit-public">{% fontawesome_icon 'edit' color='#336699' %}</a>
            </td>
            <td>
              <span class="form-public">{{ form.public.value }}</span>
              <span class="hidden editing-public">{{ form.public }}</span>
            </td>
          </tr>
          <tr>
            <td><b>Dataset status</b></td>
            <td>{{ ds.ds_status }}</td>
          </tr>
          <tr>
            <td><b>Creator</b></td>
            <td>{{ ds.creator }}</td>
          </tr>
        </table>
        <input class="btn btn-primary btn-sm hidden btn-ds" type="submit" value="Save" />
        <p> <i>Current data file</i>
          <!-- TODO: debug update, temporal data handling -->
          <!--{ if current_file.format == 'delimited' %}-->
          <!--{ if ds.owner.id == user.id or user.is_superuser%}-->
          <!--<span class="float-right mr-2">-->
            <!--<a href="#" id="a_update_modal" data-dsid = { ds.id }} data-toggle="modal" data-target="#updateModal">-->
              <!--update</a>-->
            <!--<span class="help-matches" data-id="updates">{ fontawesome_icon 'question-circle' color='#993333' %}</span>-->
          <!--</span>-->
          <!--{ endif %}-->
          <!--{ endif %}-->
        </p>
        <div id="div_file">
          <table id="file_metadata" class="ds-table table-striped">
            <tr>
              <td><b>Revision</b></td>
              <td>{{ current_file.rev }}</td>
            </tr>
            <tr>
              <td><b>File</b></td>
              <td>
                <span class="display-field">{{ current_file.file }}</span>
              </td>
            </tr>
            <tr>
              <td><b>File status</b></td>
              <td>{{ current_file.df_status }}</td>
            </tr>
            <tr>
              <td><b>Uploaded</b></td>
              <td>{{ current_file.upload_date|date:"d-M-Y, H:i (e)" }}</td>
            </tr>
            <tr>
              <td><b>Data type</b></td>
              <td>{{ current_file.datatype }}</td>
            </tr>
            <tr>
              <td><b>Format</b></td>
              <td>
                <span class="display-field">
                  {{ current_file.format }} 
                  <!--{ if ds.format == 'delimited' %}({ ds.delimiter }}){endif%}-->
                </span>
                <span class="update-field hidden">{{ form.format }}</span>
              </td>
            </tr>
            <tr>
              <td><b>License</b></td>
              <td><a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC BY 4.0</a></td>
            </tr>
            {% if current_file.format == 'delimited' %}
            <tr>
              <td><b>Columns</b></td>
              <td>{{ current_file.header }}</td>
            </tr>
            {% endif %}
          </table>
          <input class="btn btn-primary btn-sm hidden btn-file" type="submit" value="Upload" />
        </div> <!-- div_file -->
        <input type="hidden" name="owner" value="{{ ds.owner.id }}">
        <input type="hidden" name="label" value="{{ ds.label }}">
        <input type="hidden" name="datatype" value="{{ current_file.datatype }}">
        <input type="hidden" name="rev" value="{{ current_file.rev }}">
        <input type="hidden" name="format" value="{{ current_file.format }}">
        <input type="hidden" name="delimiter" value="{{ current_file.delimiter }}">
        <input type="hidden" name="df_status" value="{{ current_file.df_status }}">
        <input type="hidden" name="accepted_date" value="2020-04-01">
        <input type="hidden" name="header" value="{{ current_file.header }}">
        <input type="hidden" name="numrows" value="{{ current_file.numrows }}">
      </div>
      <div class="col-sm-4 small">
        <div id="ds_info">
          <div id="ds_stats" class="ds-card">
            <table style="width:100%">
              <!--<tr><td class="pb-3"><b>Status</b></td><td class="pb-3">{ ds.ds_status }}</td><td class="pb-3"></td></tr>-->
              <tr><th></th><th class="pb-1 text-secondary">count</th><th class="pb-1 text-secondary">added</th></tr>
              <tr><td><b>Records</b></td><td>{{ ds.numrows }}</td><td class="text-secondary">n/a</td></tr>
              {% if ds.unindexed > 0 %} 
                <tr class="text-danger">
                <td><b>Unindexed records</b></td>
                <td>{{ ds.unindexed }}</td> 
                <td class="text-secondary">n/a</td></tr>{% endif %}
              {% if ds.unreviewed > 0 %}<tr class="text-danger">{%else%}<tr>{%endif%}
                <td><b>Unreviewed hits</b></td>
                <td>{{ ds.unreviewed }}</td> 
                <td class="text-secondary">n/a</td></tr>
              <tr><td><b>Name variants</b></td><td>{{ num_names }}</td><td class="text-secondary">n/a</td></tr>
              <tr>
                <td class="pt-3"><b>Links</b></td><td class="pt-3">{{ num_links }}</td>
                <td class="pt-3"><span class="text-white bg-success">&nbsp;{{ links_added }}&nbsp;</span></td></tr>
              <tr>
                <td><b>Geometries</b></td><td>{{ num_geoms }}</td>
                <td><span class="text-white bg-success">&nbsp;{{ geoms_added }}&nbsp;</span></td></tr>
            </table>
          </div>
          <div id="ds_access" class="pt-0 px-0 ds-card">
            <p class="ds-card-header">Access</p>
            <p class="m-0 pl-2 pr-2">
              Metadata edits, dataset updates, and initiation of reconciliation tasks may only be performed by the dataset contributor ("owner" in WHG). Collaborators added by the owner under the "Sharing" tab can view the dataset and perform review of reconciliation tasks.</p>
          </div>
          {% if ds.owner.id == user.id or user.is_superuser %}
          <div id="ds_downloads" class="pt-0 px-0 ds-card">
            <p class="ds-card-header">Downloads</p>
            <p class="m-0 pl-2 pr-2">
              {% if ds.id > 2 %} <!-- exclude black, dplace, which have no upload files -->
                <a href="{% url 'datasets:dl-file' ds.id %}" ref="current">Current data file</a>
              {% endif %}
                <br/>
              {% if links_added > 0 or geoms_added > 0 %}Augmented dataset: {% endif %}
                {% if ds.numrows <= 5000 %}
                  <!--{ if current_file.format == 'delimited' %}-->
                    <!--<a href="{ url 'datasets:dl-aug' id=ds.id format='tsv' %}" ref="tsv">TSV format</a> | -->
                  <!--{ endif %}  -->
                  <!--{ elif current_file.format == 'lpf'   %}-->
                  {% if current_file.format == 'delimited' %}
                    <a href="{% url 'datasets:dl-aug' id=ds.id format='lpf' %}" ref="lpf">Linked Places format</a>
                  {% endif %}
                {% else %}  
                  <span class="red-head"><br/>Sorry, download of augmented datasets larger than 5000 rows not supported right now; too slow :^(</span>
                {% endif %}  
              <!--{ endif %}-->
            </p>
          </div>
          {% endif %}
        </div> <!-- ds_info -->
      </div> <!-- ds_details -->
      </div> <!-- row -->
      </form>
    </div> <!-- summary -->
    <div id="browse" class="tab-pane fade" role="tabpanel" aria-labelledby="browse-tab">
        <div class="container mt-3">
          <div class="row">
            <div id="drftable_detail" class="col-sm-6 pl-0">
              <div class="toomany"></div>
              <div id="mapdiv_browse">
                  <!--{ leaflet_map "map" callback="map_init" %}-->
                  {% leaflet_map "map_browse" %}
                  <div class="spinner-border text-danger"></div>
              </div>
              <!-- row detail in 2 columns, populated with getPlace() -->
              <div id="row_detail" class="row">
                <div id="detail_left" class="small col-sm-6">left side</div>
                <div id="detail_right" class="small col-sm-6">right side</div>
              </div>
            </div> <!-- drftable_detail -->
            <div id="drftable_list" class="col-sm-6">
              <table id="placetable" class="table table-striped table-bordered" style="width:100%">
                <thead>
                  <tr>
                    <th>pid</th>
                    <th>src_id</th>
                    <th>title</th>
                    <th>ccodes</th>
                    <th>geom?</th>
                  </tr>
                </thead>
              </table>
            </div>
          </div>
        </div>
      <div id="ext_site" class="modal fade" role="dialog">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span></button>
            </div>
            <div id="ext_content" class="modal-body">foo</div>
          </div>
        </div>
      </div> <!-- ext_site -->
    </div> <!-- browse -->
    <div id="reconciliation" class="tab-pane fade" role="tabpanel" aria-labelledby="reconciliation-tab">
      <div id="ds_tasks" class="small">
        <h6 class="">Reconciliation Tasks 
          <span class="small help-matches" data-id="reconciliation">
            {% fontawesome_icon 'question-circle' color='#993333' %}</span>
          {% if ds.owner.id == user.id or user.is_superuser %}
          <span class="float-right small">
            <a id="addtask_link" href="#" >Add new task {% fontawesome_icon 'plus-square' color='#336699' %}</a>
          </span>
          {% endif %}
        </h6>
        {% if messages %}<div>{% for message in messages %}
          <!--<i style="display:block;" class="text-danger ml-4 mb-2">{{ message }}</i>-->
          <p class="text-danger ml-4 mb-2">{{ message }}</p>
        {%endfor%}</div>{% endif %}
        {% if ds.owner.id == user.id or user.is_superuser or user in collaborators %}
        {% if tasks|length < 1 %}<i>None yet...</i>{% endif %}
        {% for t in tasks %}
        <div class="task-box mb-2">
          <!-- TODO: display bounds used if any -->
          <!--{ t.task_kwargs|parsejson:"bounds" }}-->
          <div class="row">
            <div class="col-sm-5">
              <p><b>Task</b>: {{ t.task_name }} <span class="small">
                ({{ t.date_done|date:"d-M-Y, H:i (e)" }}; elapsed: {{ t.result|get:"elapsed"|safe }})</span>
              </p>
              <p><b>ID</b>: {{ t.task_id }}</p>
              <p class="small">
                 <a class="confirm-del-all" data-id={{t.task_id}} href="{% url 'datasets:task-delete' tid=t.task_id scope='task' %}">
                   Delete task & hits, clear matches {% fontawesome_icon 'trash' color='#ff0000' %}</a><br/>
                   <a class="confirm-del-geoms" href="{% url 'datasets:task-delete' tid=t.task_id scope='geoms'%}">
                  Delete geometries added so far</a>
              </p>
            </div>
            <div class="col-sm-5">
              <p><b>Result</b>: {{ t.result|get:"got_hits"|safe }} records (of
                  {{ t.result|get:"count"|safe }}) got total of <b>{{ t.result|get:"total"|safe }}</b> hits</p>
              <p id="latest"></p>
              <ul>
                <li><i>Pass 1</i>
                  {% if t.result|get:"pass1" > 0 %}
                  <i>remaining</i>: <span class="strong" id='{{t.task_id}}_1'>nn</span> 
                  <a href="{% url 'datasets:review' pk=ds.id tid=t.task_id passnum='pass1' %}">
                   review</i></a>{% endif %}
                </li>
                <li><i>Pass 2</i>
                  {% if t.result|get:"pass2" > 0 %}
                  <i>remaining</i>: <span class="strong" id='{{t.task_id}}_2'>nn</span> 
                  <a href="{% url 'datasets:review' pk=ds.id tid=t.task_id passnum='pass2' %}">
                   review</i></a>{% endif %}
                </li>
                {% if t.task_name != 'align_wd' %}
                <li><i>Pass 3</i>
                  {% if t.result|get:"pass3" > 0 %}
                  <i>remaining</i>: <span class="strong" id='{{t.task_id}}_3'>nn</span> 
                  <a href="{% url 'datasets:review' pk=ds.id tid=t.task_id passnum='pass3' %}">
                   review</i></a>{% endif %}
                </li>
                {% endif %}
              </ul>            
            </div>
            <div class="col-sm-2">
              {% if t.task_name == 'align_wd' %}
                <img src="{% static 'images/Wikidata-logo-en.svg'%}" width="80"/>
              {% elif t.task_name == 'align_tgn' %}
                <img src="{% static 'images/getty80.png'%}" />
              <!--{ elif t.task_name|startswith:'align_whg'%}-->
              {% elif t.task_name == 'align_whg'%}
                <img src="{% static 'images/whg_accessioning.svg'%}" width="80"/>
              {% elif t.task_name == 'align_whg_pre'%}
                <img src="{% static 'images/whg_aligning.svg'%}" width="80"/>
              {% endif %}
            </div>
          </div> <!-- row -->
        </div> <!-- task-box -->
        {% endfor %}
        {% endif %}
      </div>
    </div>
    <div id="log" class="tab-pane fade" role="tabpanel" aria-labelledby="log-tab">
      <div id="ds_log" class="mt-2 row">
        <div class="col-sm-4">
          <h4>Dataset Log</h4>
          <ul class="ul-flush">
            {% for l in log %}
              <li class="li-flush">{{l.logtype}} ({% if l.subtype %}{{l.subtype}}{% elif l.note %}{{l.note}}{%endif%}), {{l.timestamp|date:"Y-m-d" }}</li> 
            {% endfor %}
          </ul>
        </div>
        <div id="ds_comments" class="col-sm-8 small">
          <h4>Comments</h4>
            <table class="table table-striped">
              <thead class="strong">
                <th>created (utc)</th>
                <th>place_id</th>
                <th>tag</th>
                <th>note</th>
                <th>user</th>
              </thead>
              <tbody> 
                {% for c in comments %}
                <tr><td>{{c.created|date:"Y-m-d"}}</td><td>{{c.place_id.id}}</td>
                  <td>{{c.tag}}</td><td>{{c.note}}</td><td>{{c.user}}</td></tr>
                {% endfor %}
              </tbody>
            </table>
        </div>
      </div> <!-- ds_log -->
    </div>
    <div id="sharing" class="tab-pane fade" role="tabpanel" aria-labelledby="sharing-tab">
      <form id="sharing_form" method="POST" action="{% url 'datasets:collab-add' dsid=ds.id %}" enctype="multipart/form-data">
      {% csrf_token %}
      <div></div>
        {% if messages %}<div>{% for message in messages %}
          <i style="display:block;" class="text-danger ml-4 mb-2">{{ message }}</i>
        {%endfor%}</div>{% endif %}
      <div class="sharing-box my-3 w-50">
        <div class="sharing-header">Collaborators
          {% if ds.owner.id == user.id or user.is_superuser %}
          <!--<span class="float-right small mr-2">-->
          <span class="sharing-input float-right input-group">
            <input type="text" class="form-control input-sm" name="username" placeholder="Enter username">
            <div class="input-group-append">
              <button class="btn btn-sm btn-outline-secondary" type="submit">Add</button>
            </div>
          </span>
          {% endif %}
        </div>
        <p class="p-block px-2">Collaborators are assigned per dataset. They can view its contents and metadata, and  perform review of reconciliation task results.</p>
        <ul id="collabs_list">
          {% for c in collaborators %}<li>{{ c.first_name|add:' '|add:c.last_name }} ({{c}})
          {% if ds.owner.id == user.id or user.is_superuser %}
          <span class="float-right mr-2">
            <a href="{% url 'datasets:collab-delete' uid=c.id dsid=ds.id %}">
            {%fontawesome_icon 'times-circle' color='#336699'%}</a>
          </span>{% endif %}
          </li>{% endfor %}
        </ul>
      </div>
      </form>
    </div>
    <div id="addtask" class="tab-pane" role="tabpanel" aria-labelledby="addtask-tab">
      <form action="{% url 'datasets:ds_recon' ds.id %}" method="POST">
      {% csrf_token %}
      {% if ds.owner.id == user.id or user.is_superuser %}
      <!--from context: { area_list }}-->
      <div class="row"> <!-- page-wide -->
        <div id="recon_form" class="col-md-6">
          <input type="hidden" name="ds" value="{{ ds.id }}">
          {% if user.is_superuser %}
          <div class="form-check text-danger">
            <label class="form-check-label" for="r_whg">
              <input type="radio" class="form-check-input" id="r_whg"
                name="recon" value="whg">WHG (accessioning) 
            </label>
          </div>
          <div class="form-check text-danger">
            <label class="form-check-label" for="r_whgpre">
              <input type="radio" class="form-check-input" id="r_whgpre"
                name="recon" value="whg_pre">WHG (align) 
            </label>
          </div>
          <hr/>
          {% endif %}
          <p class="font-weight-bold">Authority name source</p>
          <div class="form-check">
            <label class="form-check-label" for="r_tgn">
              <input type="radio" class="form-check-input" id="r_tgn"
                name="recon" value="tgn" checked>Getty TGN (tgn) <span class="text-danger small ml-2">approx. 3 records per second</span>
            </label>
          </div>
          <div class="form-check">
            <label class="form-check-label" for="r_wd">
              <input type="radio" class="form-check-input" id="r_wd"
                name="recon" value="wd" >Wikidata (wd) <span class="text-danger small ml-2">approx. 1 record per second</span>
            </label>
          </div>
          {% if request.method == 'GET' %}
          {% if ds.unindexed < ds.numrows %}
          <div id="recon_scope" class="mt-2">
            <hr/><p class="font-weight-bold">Task scope</p>
            <label class="radio-inline">
            <input type="radio" name="scope" id="scope1" value="all"> All <b>{{ds.numrows}}</b> records</label>
            <label class="radio-inline ml-3">
            <input type="radio" name="scope" checked="true" id="scope2" value="unindexed"> Only the unindexed (<b>{{ds.unindexed}}</b>)</label>
          </div>
          {% endif %}
          <div id="geo_constraint" class="mt-2">
            <hr/>
            <div class="mb-2">
              <p class="font-weight-bold">Geographic constraint</p>
              <p>
                <select id="select_region" name="region" class="custom-select-sm" style="width:auto;">
                  <option value="0">Select pre-defined region</option>
                  <option disabled>___________</option>
                  {% for r in region_list %}
                    <option value="{{ r.id }}">{{ r.title }}</option>
                  {% endfor %}
                </select><span class="ml-2"><b>or...</b></span></p>
              <p>
                <select id="select_userarea" name="userarea" class="custom-select-sm" style="width:auto;">
                  <option value="0" selected="selected">Select user-defined study area</option>
                  <option disabled>___________</option>
                  {% for a in area_list %}
                      <option value="{{ a.id }}">{{ a.title }}</option>
                  {% endfor %}
                  <option value="create">{ new }</option>
                </select>
              <span class="ml-2 small">
                <a href="{% url 'areas:area-create' %}?next=/datasets/{{ds.id}}/detail#addtask">create user area</a>
              </span></p>
            </div>
          </div>
          <div class="bottom">
            <hr/>
            <button type="submit" id="btn_startrecon" class="btn btn-primary">Start</button>
            <span title="back"><a id="cancel_taskadd" href="#">Cancel</a></span>
            <span id="q_accept" class="ml-3 small">
              <input id="accept_geom" name="geom" type="checkbox" checked="checked"/> accept geometries in matches
          <span class="help-matches" data-id="accept-geometry">{% fontawesome_icon 'question-circle' color='#993333' %}</span>
            </span>
          </div>
          {% endif %}
        </div> <!-- recon_form -->
        <div id="recon_result" class="col-md-6 p-tight py-2 dashedbox">
          {% if context.response and context.response != 'snap!' %}
            <div>
            <p class="text-warning">{ TODO: progress bar }</p>
            <p><b>Authority</b>: {{ context.authority }}</p>
            <p><b>Task ID</b>: {{ context.task_id }}</p>
            <p class="mb-3"><b>Result summary</b>:
              {{ context.result }}    </p>
            <a href="{% url 'datasets:dataset-detail' id=ds.pk %}">
              <input class="btn btn-sm btn-outline-primary" type="text" value="Return to Dataset"/></a>
            <!-- TODO: refactor this; direct to first non-zero pass -->
            {% if context.result.pass1 > 0 %}
              <a href="{% url 'datasets:review' pk=ds.pk tid=context.task_id passnum='pass1' %}">
            {% elif context.result.pass2 > 0 %}
              <a href="{% url 'datasets:review' pk=ds.pk tid=context.task_id passnum='pass2' %}">
            {% else %}
              <a href="{% url 'datasets:review' pk=ds.pk tid=context.task_id passnum='pass3' %}">
            {% endif %}
            <input class="btn btn-sm btn-outline-primary" type="text" value="Review Hits"/>
            </a></div>
          {% elif context.response == 'snap!' %}
            <div><p>{{ context.result }}</p>
            <p><a href="javascript:history.back()">Return to dataset portal</a></p></div>
          {% endif %}
          {% if request.method == 'GET' %}
          <div id="mapdiv_recon" class="mt-2">
            <!--{ leaflet_map "map_recon" callback="map_init2" %}-->
            {% leaflet_map "map_recon" %}
          </div>
          {% endif %}
        </div> <!-- recon_result -->
      </div> <!-- row -->
      {% else %}
      <div><p class="pl-3 text-danger"><b>Sorry, reconciliation tasks can only be initiated by the dataset owner.</b></p></div>
      {% endif %}
      </form>
        <!--<div class="selector py-3"><div id="updater"></div></div>-->
        <div class="selector py-3"><div id="helpme"></div></div>
      </div> <!-- .row -->
    </div> <!-- #addtask -->
  </div> <!-- .tab-content -->
  <div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="updateModalLabel">
            Update <span class="text-danger">{{ ds.label }}</span> dataset <small>(<i>{{ current_file.format }} file only</i>)</small>
          </h5>
          <!--<button type="button" class="close" data-dismiss="modal" aria-label="Close">-->
            <!--<span aria-hidden="true">&times;</span>-->
          <!--</button>-->
        </div>
        <div class="modal-body">
          <div class="form-group">
            <form id="newfileform" method="POST" action="#" enctype="multipart/form-data">
              {% csrf_token %}
              <div id="loadfile">
                <p><input type="file" id="newfile"></p>
                <button id="btn_upload" type="submit" class="btn btn-primary btn-sm hidden">Upload</button>
              </div>
              <div id="update_spinner"></div>
              <div id="results_text" class="mb-2 small ds-card">
                <p>Uploaded data will be compared with existing data, and results reported here.</p>
                  <p>You may then proceed, or cancel this operation with no changes made.</p>
                <!--{ if links_added > 0 or geoms_added > 0 %}-->
                <!--<p>This dataset has been augmented with { links_added }} links and { geoms_added }} geometries-->
                <!--via reconciliation tasks. </p>-->
                <!--{ endif %}-->
              </div>          
            </form>
          </div> <!-- .form-group -->
        </div> <!-- .modal-body -->      
        <div class="modal-footer">
          <div id="buttons_pre">
            <button id="btn_cancel" type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Cancel</button>
            <button id="btn_update" type="button" data-dsid={{ds.id}} class="btn btn-primary btn-sm hidden">
              Proceed</button>
          </div>
          <button id="btn_done" type="button" class="btn btn-secondary btn-sm hidden" data-dismiss="modal">Done</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!--
js for Summary, Reconciliation
-->
<script type="text/javascript">
  // show/hide geo constraint options
  $("#r_tgn").click(function(){console.log('tgn now');$("#geo_constraint").show(400)})
  $("#r_wd").click(function(){console.log('wd now');$("#geo_constraint").hide(400)})
  
  $("#a_update_modal").on('click', function(e){
    console.log('clicked update')
    if('{{ current_file.format }}' != 'delimited'){ 
        alert('Sorry, update is available for delimited files right now. Soon...')
      }
  })
  // show upload button after file selected
  $("#newfile").on("change", function() {
    $("#btn_upload").removeClass('hidden')
  });
  
  $("#btn_done").on('click', function(){ location.reload(); })
  $("#btn_cancel").on('click', function(){ location.reload(); })
  
  function startUpdateSpinner(){
    window.spinner_update = new Spin.Spinner().spin();
    $("#update_spinner").append(spinner_update.el);   
  }
  function startReconSpinner(){
    window.spinner_recon = new Spin.Spinner().spin();
    $("#map_recon").append(spinner_recon.el);   
  }
  function startDownloadSpinner(){
    window.spinner_dl = new Spin.Spinner().spin();
    $("#ds_downloads").append(spinner_dl.el);   
  }
  <!--$("#ds_downloads a").click(function(){console.log($(this)})-->
  $("#ds_downloads a").click(function(e){
    urly='/datasets/{{ds.id}}/augmented/'+$(this).attr('ref')
    startDownloadSpinner()
    $.ajax({
            type: 'GET',
            url: urly
        }).done(function() {
            spinner_dl.stop();
        })
  })
  
  $("#btn_startrecon").click(function(e){
    startReconSpinner()
  })
  <!--$('a[ref="dl"]').click(function(){startDownloadSpinner()})-->
  // parse & prettify ds_update() results
  function updateText(data){
    // { "status": "updated", "#updated": 133, "#new": 2, "newfile": "media/user_whgadmin/diamonds135_0t_h0b7.tsv", "format": "delimited" }
    html = 'Update changes: <br/>' + 
           'Added '+data["new_count"]+' rows <br/>'+ 
           'Deleted '+data["del_count"]+' rows <br/>'+ 
           'Updated '+data["update_count"]+' rows <br/>'+ 
           'in database'
    html += data['indexed'] == false?'.':' and in WHG index.'
    return html
  }
  // performs ds_update()
  $("#btn_update").on('click', function(){
    console.log('compare_data',compare_data)
    startUpdateSpinner()
    var formData = new FormData();
    formData.append('dsid', '{{ ds.id }}');
    formData.append('format', '{{ current_file.format }}');
    formData.append('keepg', $("#preserve_geoms").length ? $('#preserve_geoms')[0].checked : "true");
    formData.append('keepl', $("#preserve_links").length ? $('#preserve_links')[0].checked : "true");
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('compare_data',JSON.stringify(compare_data));
    
    $.ajax({
      type: 'POST',
      enctype: 'multipart/form-data',
      url: '/datasets/update/',
      processData: false,
      contentType: false,
      cache: false,
      data: formData,
      success:function(data){
        console.log('update result data',data)
        $("#buttons_pre").addClass('hidden')
        $("#btn_done").removeClass('hidden')
        html = '<h6>update complete!</h6>'
        html += updateText(data)
        $("#results_text").html(html)
        spinner_update.stop()
      }
    })
  })
  
  // parse & prettify ds_compare() results
  function comparisonText(data) {
      stats = data['compare_result']
      keepg = data['keepg']; keepl = data['keepl'];
      <!--keepers_note='Keep existing: geometry? <b>'+keepg+'</b>; links? <b>'+keepl+'</b>';-->
      html = 'This action would perform these WHG <i>database</i> updates:<br/><ul style="padding:0;list-style: inside;">'
      html += '<li>Replace <b>'+stats['count_replace']+'</b> place records having same IDs </li>'
      html += stats['rows_add'].length >0?'<li>Add records (<b>'+stats['rows_add'].join(', ')+'</b>)</li>':''
      html += stats['rows_del'].length >0?'<li>Remove records (<b>'+stats['rows_del'].join(', ')+'</b>)</li>':''
      html += stats['cols_add'].length >0?'<li>Add columns (<b>'+stats['cols_add']+'</b>)</li>':''
      html += stats['cols_del'].length >0?'<li>Remove columns (<b>'+stats['cols_del']+'</b>)</li>':''
      if (data['count_geoms']>0){
        html += '<li class="text-danger">There are <b>'+data['count_geoms']+'</b> existing place-geometry records...keep them?'+
        ' <input type="checkbox" id="preserve_geoms" checked></li>'
      }
      if (data['count_links']>0){
        html += '<li class="text-danger">There are <b>'+data['count_links']+'</b> existing place-link records...keep them?'+
        ' <input type="checkbox" id="preserve_links" checked></li>'
      }
      html += '</ul>'
      html += data['count_indexed'] > 0 ? '<p>Also, in the WHG <u>index</u>, <b>'+stats['count_replace'] + '</b> records would be updated, and <b>'+stats['rows_del'].length+'</b> removed.</p>':''
      html += stats['rows_add'].length >0 ? 'The '+stats['rows_add'].length+' record(s) added to the database will have to be reconciled and accessioned.':''
    return html
  }

  // submit new file for comparison
  // prepares compare_data{} object, passed to ds_update if/when 'proceed' is clicked
  $(document).on('submit', '#newfileform', function(e){
    e.preventDefault()
    var formData = new FormData();
    formData.append('file', $('#newfile')[0].files[0]);
    formData.append('dsid', '{{ ds.id }}');
    formData.append('format', '{{ current_file.format }}');
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    <!--console.log(fileName,fileSize)-->
    $.ajax({
      type: 'POST',
      enctype: 'multipart/form-data',
      url: '/datasets/compare/',
      processData: false,
      contentType: false,
      cache: false,
      data: formData,
      success:function(data){
        console.log('data returned',data)
        if('failed' in data){
          errors = data['failed']['errors']
          html = '<b class="text-danger">Data validation issue(s):</b> <ul class="ul-flush">'
          <!--html+=JSON.stringify(data['failed']['errors'])-->
          var i = 0; i < 9; i++
          for(var i=0; i<errors.length; i++){
            <!--html += '<p>'+errors[i]['message']+'</p>'-->
            html += '<li class="li-flush">'+errors[i]+'</li>'
          }
          html+='</ul><p>Please correct and try again</p>'
        } else {
          html = '<b>Current file</b>: <br/><i>'+data['filename_cur']+'</i><br/>'
          html += '<b>New file</b>: <br/><i>'+data['filename_new']+'</i><br/>'
          html += '<b>New temp file</b>: <br/><i>'+data['tempfn']+'</i><br/>'
          html += '<b>Validation result</b>: <br/><i>' + 
            (data['validation_result']['errors'].length <1?'format valid':data['validation_result']['errors'])+'</i><hr/>'
          html += comparisonText(data)
          $("#btn_update").removeClass('hidden')
        }
        $("#loadfile").addClass('hidden')
        $("#results_text").html(html)
        compare_data=data
      }
    })
  })
  
  // TODO: refactor this ugly nonsense
  $(".edit-title").click(function() {
    $(".editing-title").toggleClass("hidden")
    $(".form-title").toggleClass("hidden")
    $(".btn-ds").toggleClass("hidden")
  })
  $(".edit-description").click(function() {
    $(".editing-description").toggleClass("hidden")
    $(".form-description").toggleClass("hidden")
    $(".btn-ds").toggleClass("hidden")
  })  
  $(".edit-public").click(function() {
    $(".editing-public").toggleClass("hidden")
    $(".form-public").toggleClass("hidden")
    $(".btn-ds").toggleClass("hidden")
  })  
  $(".edit-uri_base").click(function() {
    $(".editing-uri_base").toggleClass("hidden")
    $(".form-uri_base").toggleClass("hidden")
    $(".btn-ds").toggleClass("hidden")
  })  
  $(".edit-webpage").click(function() {
    $(".editing-webpage").toggleClass("hidden")
    $(".form-webpage").toggleClass("hidden")
    $(".btn-ds").toggleClass("hidden")
  })  
  $(function(){
    if('{{ status }}' == 'updating'){
      console.log('{{ status }}','{{ context }}')
      $("#ds_info").addClass('hidden')
      $("#ds_updating").removeClass('hidden')
      $("#div_file").toggleClass('border-red')
      $(".update-msg").removeClass('hidden')
    }
    
    // manage url
    var url = document.location.toString();
    <!--console.log('url, context on load',url,"{{context}}".length)-->
    if (url.match('#')) {
      tab = url.split('#')[1]
      $('.nav-tabs a[href="#' + tab+ '"]').tab('show');
    } else if ("{{context}}".length > 0){
      taburl = location.protocol+'//'+location.host+'/datasets/'+'{{ds.id}}'+'/detail#reconciliation'
      $('.nav-tabs a[href="#reconciliation"]').tab('show');
      location.href=taburl
    }
    //***
    // Browse onload
    //***
    spinner_map = new Spin.Spinner().spin();
    $("#map").append(spinner_map.el);
    
    window.dslabel = "{{ ds.label }}"
    window.table = $('#placetable').DataTable({
      "serverSide": true,
      "ajax": "/api/placetable/?format=datatables&ds={{ ds.label }}&f={{ filter }}",
      "columns": [
          {"data": "id", "searchable": false},
          {"data": "src_id", "searchable": false},
          {"data": "title"},
          {"data": "ccodes"},
          {"data": "geo", "sortable": false, "searchable": false},
      ],
    })
    table.on( 'draw', function () {
      setRowEvents();
    });
    // end Browse onload js
    
    $("#cancel_taskadd").click(function(e){
      e.preventDefault();
      $('#addtask_li').addClass('hidden')
      $('.nav-tabs a[href="#reconciliation"]').tab('show');
      location.reload()
    })
    $("#addtask_link").click(function(e){
      e.preventDefault()
      window.location.hash = "#addtask"
      $("#addtask_li").removeClass('hidden')
      $('.nav-tabs a[href="#addtask"]').tab('show');
      mappyr.invalidateSize()
    })

    // Change hash for page-reload
    $('.nav-tabs a').on('shown.bs.tab', function (e) {
      window.location.hash = e.target.hash;
      if(e.target.hash=="#reconciliation"){
        updateTotals('{{ ds.id }}')
      }
      if(e.target.hash=="#browse"){
        mappy.invalidateSize();
        $("html,body").scrollTop(0)
        // TODO: features not available on reload
        mappy.fitBounds(features.getBounds())
      }
      if(e.target.hash=="#addtask"){
        mappyr.invalidateSize();
        $("html,body").scrollTop(0)
      }
    })
    
    // TODO: reload should NOT be necessary
    updateTotals('{{ ds.id }}')
    steps={"uploaded":1,"reconciling":2,"review_hits":3,"reviewed":4,"review_whg":5,"indexed":6}
    $("[ref="+steps['{{ ds.ds_status }}']+"]").addClass('prog-active')

    $("#collabs_list a").click(function(){
      <!--console.log($(this).data('uid'))-->
    })   
    $(".help-matches").click(function(){
      page=$(this).data('id')
      $('.selector').dialog('open');
    })
    $(".selector").dialog({
      resizable: false,
      autoOpen: false,
      height: 500,
      width: 700,
      title: "WHG Help",
      modal: true,
      buttons: { 'Close': function() {console.log('close dialog'); $(this).dialog('close');} },
      open: function(event, ui) {
        $('#helpme').load('/media/help/'+page+'.html')
      },
      show: {effect: "fade",duration: 400 },
      hide: {effect: "fade",duration: 400 }
    });
  })
  function updateTotals(dsid){
    $.get("/datasets/updatecounts",{ds_id: dsid},
      function(data){
        updates=data
        <!--console.log('fired updateTotals()',updates, dsid)-->
        for(u in updates){
          html1='';html2='';html3='';
          <!--console.log(updates[u])-->
          html1+=updates[u]['pass1']
          html2+=updates[u]['pass2']
          html3+=updates[u]['pass3']
          $("#"+u+'_1').html(html1)
          $("#"+u+'_2').html(html2)
          $("#"+u+'_3').html(html3)
        }
      }
    )
  }
  $("[rel='tooltip']").tooltip();

  $(".confirm-del-geoms").click(function(){
    return confirm('DANGER! Deletes all place_geom records created so far in Review step');
  })
  $(".confirm-del-all").click(function(){
    id=$(this).data('id')
    return confirm('DANGER! Destroys task, its hits, and clears matches confirmed in Review step...'+id);
  })
</script>
<!--
js for Add Task
-->
<script type="text/javascript">
  function render_area(aid) {
    $.ajax({
        url: '/api/area/'+aid
      }).done(function(data){
        <!--console.log('render_area()',data)-->
        geom = {"type":"FeatureCollecton","features":[]}
        geom['features'].push(data.geojson)
        renderMap(geom,'area')
    })
  }
  // clear dropdown choice if other is used & render geometry
  $( "#select_region" ).change(function() {
    $( "#select_userarea option[value=0]" ).prop('selected',true)
    if ($(this).val() == 0) { features.clearLayers() } else{ render_area( $(this).val(), 'region') }
  });
  
  $( "#select_userarea" ).change(function() {
    $( "#select_region option[value=0]" ).prop('selected',true)
    if ($(this).val() == 0) { features.clearLayers() } else{ render_area( $(this).val(), 'area') }
    if ($( "#select_userarea option[value='create']" ).prop('selected') == true) {
      location.href="{% url 'areas:area-create' %}?next={% url 'datasets:ds_recon' ds.id %}"
    }
  });
</script>
<!--
js for Browse
-->
<script src="//cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="//cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>

<script  type="text/javascript">
  $("[rel='tooltip']").tooltip();
  $('.vocab').on('click', function(e) {
    <!--e.preventDefault();-->
    <!--str=$(this).text()-->
    console.log('id',$(this).data('id'))
    <!--var re = /(http|dbp|gn|tgn|wd|loc|viaf|aat):(.*?)$/;-->
    <!--url=str.match(re)[1]=='http' ? str : base_urls[str.match(re)[1]]+str.match(re)[2]-->
    <!--window.open(url,'_blank')-->
  });  
  function setRowEvents(){
    $("#placetable tr").click(function() {
        t=$(this)
        pid=$(this)[0].cells[0].textContent
        var selected = $(this).hasClass("highlight-row");
        $("#placetable tr").removeClass("highlight-row");
        if(!selected)
          $(this).removeClass( "rowhover" );
          $(this).addClass("highlight-row");
        if(typeof(idToFeature) != 'undefined'){
          if(pid in idToFeature){
            feat = idToFeature[pid]
            ftype = feat.feature.geometry.type
            // reset style for all if we've zoomed
            if(typeof foptions !== 'undefined'){
              features.setStyle(foptions)
            }
            // focus this one
            // TODO: an appropriate zoom
            feat.setStyle(styles[ftype].focus)
            feat.bringToFront()
            // account for lines and polygons
            // mappy.setView(feat._latlng);
            mappy.setView(ftype=='Point'?feat._latlng:feat.getCenter());
          } else {
            features.setStyle(foptions)
          }
        }
        getPlace(pid)
      }
    ) 
        
    row = $("#drftable_list table tbody")[0].rows[0]
    pid = parseInt(row.cells[0].textContent)
    // display first row detail
    $("#placetable tbody").find('tr').eq(0).addClass('highlight-row')
    getPlace(pid)
  }
  function focusFeature(feat){
    console.log('feat',feat)
    feat.setStyle(styles[feat.feature.geometry.type].focus)
    <!--mappy.setView(feat._latlng, 3);-->
  }
  // responds to leaflet_map tags in both #browse and #addtask tabs
  addEventListener('map:init', function (e) {
    <!--console.log('map id:',e.detail.id) // map_browse or map_recon-->
    // layers common to both
    var attrib_mb = 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
            '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
      token_mb = '{{ mbtokenmb }}',
      token_kg = '{{ mbtokenkg }}',
      mbstyle_url = 'https://api.mapbox.com/styles/v1/{id}/tiles/256/{z}/{x}/{y}?access_token={token}';
      
    var satellite  = L.tileLayer(mbstyle_url, {id:'mapbox/satellite-streets-v11', token:token_mb, attribution:attrib_mb})
    var osm  = L.tileLayer(mbstyle_url, {id:'mapbox/light-v10', token:token_mb, attribution:attrib_mb})

    var baseLayers = {
      "OSM": osm,
      "Satellite": satellite
    };

    
    if (e.detail.id == 'map_browse'){
      // it's the Browse map, name it mappy
      window.mappy = e.detail.map
      mappy.setMaxBounds(null)
      L.control.layers(baseLayers).addTo(mappy);
      baseLayers['OSM'].addTo(mappy)
      
      var printer = L.easyPrint({
        tileLayer: osm,
        sizeModes: ['Current'],
        filename: 'myMap',
        exportOnly: true,
        hideControlContainer: true
      }).addTo(mappy)
      
      // get dataset features -> renderMap() if < 15,000
      $.get("/api/geoms", {ds: "{{ ds.label }}", f: "{{ filter }}" },
        function(data){
          <!--console.log('feature count:',data.count)-->
          geom = {"type":"FeatureCollection","features":data.results}
          if(geom.features.length >= 15000) {
            $(".toomany").html('for performance reasons, mapping only the first 15,000 features - sorry!')
          }
          if(geom.features.length <= 15000) {
            renderMap(geom,'browse')
          } else {
            spinner.stop()
            $(".toomany").html('too many features to map (> '+geom.features.length+'), sorry!')
          }
      })  
    } else {
      // it's map_recon in #addtask tab, name it mappyr
      window.mappyr = e.detail.map
      mappyr.setMaxBounds(null)
      L.control.layers(baseLayers).addTo(mappyr);
      baseLayers['OSM'].addTo(mappyr)
      mappyr.invalidateSize()
    }

    function manualPrint () {
        printer.printMap('CurrentSize', 'MyManualPrint')
    }
  }, false);
  
  
  function url_modal(identifier) {
    <!-- e.g. 'wd:Q123456' OR 'http://whatever.com/places/09384'-->
    <!--link = ' <a href="" class="ext" data-toggle="modal" data-target="#ext_site">'+identifier+-->
    link = ' <a href="" class="ext" data-target="#ext_site">'+identifier+
      ' {% fontawesome_icon 'external-link' color='#336699' %}</a>'
    return link
  }
  function url_tab(type) {
    link = ' <a href="#" class="exttab" data-id='+type.identifier+
      '>('+type.label+' {% fontawesome_icon 'external-link' color='#336699' %})</a>'
    return link
  }
  
  styles = {
    "Point": {
      "default": {radius: 1, fillColor:"#ff9900", fillOpacity: 0.8, stroke: false},
      "focus": {radius:8, fillColor:"#ffff00",fillOpacity:1, stroke:true, weight:1,color:"#000"}},
    "MultiLineString": {
      "default":{opacity: 1, weight: 1, color: "#336699"},
      "focus":{}},
    "MultiPolygon": {
      "default":{fillOpacity: 0.4, opacity: 1, color: "#fff", weight: 1, fillColor:"#993333"},
      "focus":{}
    }
  }
  // dual purpose for browse and recon
  function renderMap(geom, tab){
    // call the map being rendered 'mappo'
    mappo = tab=='browse'?mappy:mappyr
    if (geom.features.length==0) {
      console.log('no features in renderMap() call')
    } else {
      // clear existing if any
      if(typeof(features)!=='undefined'){
        mappo.removeLayer(features)
      }
      idToFeature = {}  // for feature lookup
      features = L.geoJSON(geom, {
      // feature here is a geometry
      // TODO: LPF v1.2 to allow single geometry or GeometryCollection
        pointToLayer: function (feature, latlng) {
          matchid = feature.place_id
          <!--console.log('feature',feature)-->
          marker = L.circleMarker(latlng,styles.Point.default).bindPopup(feature.title+
            '<br>pid: <a href="'+window.location.origin+'/api/db?id='+matchid+'" target="_blank">'+
            matchid+'</a>');
          idToFeature[matchid] = marker
          return marker
        }
        ,onEachFeature: function(feature,layer) {
          f=feature; l=layer;
          <!--console.log('f,l',feature,layer)-->
          identifier = feature.place_id;
          if(feature.type != 'Point'){
            <!--layer.setStyle(styles.default)-->
            idToFeature[identifier] = layer
          }
        }
      }).addTo(mappo);
      <!--});-->
    }
    mappo.fitBounds(features.getBounds())
    mappo.on('zoomend', function() {
      var currentZoom = mappy.getZoom();
      var myRadius = currentZoom*(1); //or whatever ratio you prefer
      var myWeight = currentZoom*(1/5); //or whatever ratio you prefer
      features.setStyle({radius: myRadius, weight: myWeight});
      opt = Object.values(idToFeature)[0].options
      foptions = { ...opt };
      <!--console.log('zoomend() idToFeature',opt)-->
    });
    opt = Object.values(idToFeature)[0].options
    foptions = { ...opt };
  }
  
  function minmaxer(timespans){
    <!--console.log('got to minmax()',JSON.stringify(timespans))-->
    starts=[]; ends=[]
    for (t in timespans){
      // gets 'in', 'earliest' or 'latest'
      starts.push(Object.values(timespans[t].start)[0])
      ends.push(!!timespans[t].end ? Object.values(timespans[t].end)[0] : -1)
    } 
    <!--console.log('starts',starts,'ends',ends)-->
    minmax=[Math.max.apply(null, starts),Math.max.apply(null, ends)]
    return minmax
  }

  // TODO: better parsing here
  function parsePlace(data,side) {
    window.featdata = data
    
    function onlyUnique(array) { 
      const map = new Map();
      const result = [];
      for (const item of array) {
        if(!map.has(item.identifier)){
            map.set(item.identifier, true);
            result.push({
                identifier: item.identifier,
                type: item.type
            });
        }
      }
      return(result)
    }
    <!--timespan_arr = []-->
    //
    // TITLE 
    left='<p><b>Title</b>: <span id="row_title" class="larger text-danger">'+data.title+'</span>'
    //
    // NAME VARIANTS
    left+='<p class="scroll60"><b>Variants</b>: '
    for (n in data.names) {
      let name = data.names[n]
      left+= '<p>'+name.toponym !=''?name.toponym+'; ': ''
    }
    //
    // TYPES
    // may include sourceLabel:"" **OR** sourceLabels[{"label":"","lang":""},...]
    // NOTE TO SELF: Change LP format spec VERY carefully
    // console.log('data.types',data.types)
    // {"label":"town","identifier":"aat:300001234","sourceLabels":[{"label":"Military Town","lang":"en"}]}
    left+='</p><p><b>Types</b>: '
    typeids = ''
    for (t in data.types) {
      str = ''
      var type = data.types[t]
      if('sourceLabels' in type){
        srclabels = type.sourceLabels
        for(l in srclabels){
          label = srclabels[l]['label']
          str = label !='' ? label + '; ' : ''
        }
      } else if ('sourceLabel' in type) {
        str = type.sourceLabel !='' ? type.sourceLabel + '; ' : ''
      }
      if(type.label!=''){ str += url_tab(type) + ' ' }
      typeids+=str
    }
    left += typeids.replace(/(; $)/g, "") +'</p>'
    
    //
    // LINKS
    // TODO: normalize on closeMatch, exactMatch
    left += '<p class="mb-0"><b>Linked records</b>: </p>'
    close_count = exact_count = related_count = 0
    html_exact = html_close = html_related = ''
    if (data.links.length > 0) {
      window.links=data.links
      links_arr = onlyUnique(data.links)
      <!--console.log('distinct data.links',links_arr)-->
      for (l in links_arr) {
        if (links_arr[l].type.substring(0,5) == 'exact') {
          exact_count += 1
          html_exact+=url_modal(links_arr[l].identifier)
        }
        else if (links_arr[l].type.substring(0,5) == 'close') {
          close_count += 1
          html_close+=url_modal(links_arr[l].identifier)
        }
        else if (links_arr[l].type == 'related') {
          related_count +=1
          html_related+=url_modal(links_arr[l].identifier)
        }
      }
      if (exact_count > 0) left += '<i>exactMatch</i>: ['+html_exact+' ]'
      if (close_count > 0) left += ' <i>closeMatch</i>: ['+html_close+' ]'
      if (related_count > 0) left += ' <i>related</i>: ['+html_related+' ]'
    } else { left += "<i class='small'>no links established yet</i>" }

    //
    // RELATED
    right=''
    if (data.related.length > 0) {
      right_parent='<p class="mb-0"><b>Parent(s)</b>: '; 
      right_related='<p class="mb-0"><b>Related</b>: ';
      for (r in data.related){
        rel = data.related[r]
        console.log('rel',rel)
        if (rel.relation_type == 'gvp:broaderPartitive'){
          right_parent += '<span class="small h1em">'+rel.label
          right_parent += 'when' in rel && !('timespans' in rel.when) ? 
            ', '+rel.when.start.in+'-'+rel.when.end.in : 
            'when' in rel && ('timespans' in rel.when) ? ', '+
              minmaxer(rel.when.timespans) : ''
              <!--rel.when.timespans : ''-->
          right_parent += '</span>; '
        } 
        else {
          right_related += '<p class="small h1em">'+rel.label+ ', '+rel.when.start.in+'-'+rel.when.end.in+'</p>'
        }
      }
      right+=right_parent.length > 39?right_parent:''
      right+=right_related.length > 37?right_related:''
    }
    //
    // DESCRIPTIONS
    // TODO: link description to identifier URI if present
    if (data.descriptions.length > 0) {
      val = data.descriptions[0]['value'].substring(0,300)
      right+='<p><b>Description</b>: '+(val.startsWith('http')?'<a href="'+val+'" target="_blank">Link</a>':val)
        +' ... </p>'
        <!--'<br/><span class="small red-bold">('+data.descriptions[0]['identifier']+')</span>-->
    }
    //
    // CCODES
    //
    <!--if (data.ccodes.length > 0) {-->
    if (!!data.countries) {
      <!--console.log('data.countries',data.countries)-->
      right+='<p><b>Modern country bounds</b>: '+ data.countries.join(', ')+'</p>'
    }
    //
    // MINMAX
    //
    if(data.minmax && data.minmax.length>0){
      right += '<p><b>When</b>: earliest: '+data.minmax[0]+'; latest: '+data.minmax[1]    
    }
    left += '</div>'
    right += '</div>'
    return side=='left'?left:right
  }
  // $('#myModal').modal('show');
  function getPlace(pid){
    $.ajax({
      url: "/api/place/"+pid,
      }).done(function( data ) {
        $("#detail_left").html(parsePlace(data,'left'))
        $("#detail_right").html(parsePlace(data,'right'))
        $('.ext').on('click', function(e) {
          e.preventDefault();
          str=$(this).text()
          console.log('str (identifier)',str)
          // URL identifiers can be 'http*' or an authority prefix
          if(str.substring(0,4).toLowerCase() == 'http'){
            url = str
          } else {
            var re = /(dbp|gn|tgn|wd|aat|viaf):(.*?)$/;
            url=base_urls[str.match(re)[1]]+str.match(re)[2] 
            console.log('url',url)
          }
          window.open(url, '_blank');
          // TODO: refactor when to open modal or not (gn disallows)
          <!--if (str.match(re)[1]== 'gn'){-->
            <!--window.open(url, '_blank');-->
            <!--return-->
          <!--} else {-->
            <!--$(".modal-body").html('<iframe width="100%" height="100%" frameborder="0" scrolling="yes" '+-->
              <!--'allowtransparency="true" src="'+url+'"></iframe>');            -->
          <!--}-->
        });
        $('.exttab').on('click', function(e) {
          e.preventDefault();
          id=$(this).data('id')
          console.log('id',id)
          var re = /(http|dbp|gn|tgn|wd|loc|viaf|aat):(.*?)$/;
          url=id.match(re)[1]=='http' ? id : base_urls[id.match(re)[1]]+id.match(re)[2]
          console.log('url',url)
          window.open(url,'_blank')
        }); 
    });
  }
  // initialize maps 
  function map_init_browse (map, options) {
    console.log('map_init_browse(); wtf?')  } 
    
  function map_init_recon (map, options) {
    console.log('map_init_recon(); wtf?')
  }
  // generic 
  function zoomTo(id) {
    mappy.setView(idToFeature[id]._latlng, mappy.getZoom() +2 )
  }

</script>
{% endblock %}

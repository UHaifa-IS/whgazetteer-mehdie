<!-- datasets/review.html -->
{% extends "main/base.html" %}
{% load dataset_extras %}
{% load fontawesome %}
{% load leaflet_tags %}
{% load render_table from django_tables2 %}
{% load static %}

{% block title %}<title>Review hits::{{ ds_label }}>{{authority}}</title>{% endblock %}
{% block extra_head %}
  {% leaflet_js %}
  {% leaflet_css %}
  <script src="{% static 'js/aliases.js' %}"></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.css' rel='stylesheet' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.js'></script>
  <script src="{% static 'js/leaflet-mapbox-gl.js' %}"></script>
{% endblock %}
{% block content %}
<div class="container">
  <!-- incoming: ds, hit_list -->
  <h5 class="mb-2 mt-3">{% if authority == 'idx' %}Accessioning{%else%}Reconciliation {%endif%} Review (2): 
    <span class="small"> 
      <a href="{% url 'datasets:ds_reconcile' id=ds_id %}">
        {{ ds_label }}</a> <!--{ if authority != 'whg' %}> {{ authority }} {endif%}-->
      <!--<select id="select_pass" name="pass" class="custom-select-sm mr-2" style="width:auto;">-->
        <!--{# if count_pass0 > 0 %}-->
        <!--<option value="pass0">PASS 0 (auto-matched)&nbsp;</option>{# endif %}-->
        <!--{# if count_pass1 > 0 %}-->
          <!--<option value="pass1">PASS 1&nbsp;</option>{# endif %}-->
        <!--{# if count_pass2 > 0 %}-->
          <!--<option value="pass2">PASS 2&nbsp;</option>{# endif %}-->
        <!--{# if authority == 'tgn' and count_pass3 > 0 %}-->
          <!--<option value="pass3">PASS 3&nbsp;</option>{# endif %}-->
      <!--</select>-->
    </span>
    <span class="half float-right">
      task id: {{ task_id }} <!--(+links{ if aug_geom == 'on' %}+geom{ endif %})-->
    </span>
  </h5>
  {% if nohits %}
    <div>
      <p>No unreviewed hits for this reconciliation task!</p>
      <p><a href="{% url 'datasets:ds_reconcile' id=ds_id %}">Return to dataset detail page</a></p>
    </div>
  {% else %}
    <!--<form id="form_related" method="POST" action="" >-->
    <!--{ csrf_token %}-->
    <!--{ formset.management_form }}-->
    <!--{ for record in records %} <!-- there is only one; if last, do nothing -->
    <div class="container">
      <div id="review_nav" class=" row pagination justify-content-center">
        <div class="col-sm-6 pl-1">nav left
          <!--<a id="undo" class="small hidden-imp" href="" data-url="{# url 'datasets:match-undo' ds=ds_id tid=task_id pid=999 %}">-->
              <!--Undo last save {# fontawesome_icon 'undo' color='#336699' %}</a>--></div>
        <div class="col-sm-6">nav right
        <!--<span><button type="submit" id="btn_save" class="button-sm">Save</button>-->
        <!--<span class="step-links">-->
            <!--{# if records.has_previous %}-->
                <!--<a href="?page=1">&laquo; first</a>&nbsp;&nbsp;-->
                <!--<a href="?page={ records.previous_page_number }}">previous</a>-->
            <!--{# endif %}-->
            <!--<span class="current">-->
                <!--Record { records.number }} of { records.paginator.num_pages }}-->
            <!--</span>-->
            <!--{# if records.has_next %}-->
                <!--<a href="?page={ records.next_page_number }}">next</a>&nbsp;&nbsp;-->
                <!--<a href="?page={ records.paginator.num_pages }}">last &raquo;</a>-->
            <!--{# endif %}-->
        <!--</span>-->
        </div>
      </div>
      <div id="review" class="row mt-2">
        <div id="review_placelist" class="col-sm-2">
          {% render_table place_list %}
        </div>
        <div id="review_record" class="col-sm-4 pl-0 small">
          <div class="bg-secondary font-weight-bold pl-2 text-light">{{ dataset_label }}</div>
          <div id="place_record" class="mb-2">
            <div id ="place_detail">place_detail</div>
            <div id="map">
              {% leaflet_map "map_review" callback="map_init" %}
            </div>
          </div>
        </div>
        <!--available: ['whg_id', 'place_id', 'src_id', 'title', 'dataset', 'variants', 'types', 'ccodes', 'parents', 'descriptions', 'geoms', 'timespans', 'links']-->
        <div id="review_hitlist" class="col-sm-6 pr-0">
          {% render_table hit_list %}
        </div>
      </div> <!-- .row -->
    </div> <!-- container flex -->
    </form>

  <!--{ endfor %} <!-- record in records -->
  {% endif %}
  <div class="modal fade" tabindex="-1" role="dialog" id="modal">
  <div class="modal-dialog modal-form" role="document">
    <div class="modal-content"></div>
  </div>
  <div class="selector py-3"><div id="helpme" class="my-3"><div></div>
</div>
<script type="text/javascript">
  // capture pid for place just reviewed
  // https://catalogue.bnf.fr/ark:/12148/cb11942741p
  function setRowEvents(){
    $("#review_placelist tr").click(function() {
        t=$(this)
        // get src_id
        src_id=$(this)[0].cells[0].textContent
        
        // highlight this row, clear others
        var selected = $(this).hasClass("highlight-row");
        $("#place_list tr").removeClass("highlight-row");
        
        if(!selected)
          $(this).removeClass( "rowhover" );
          $(this).addClass("highlight-row");

        <!--getPlace(pid)-->
        getPlace(src_id, '{{ ds_id }}')
      }
    ) 
        
    // display first row detail on start
    row = $("#review_placelist table tbody")[0].rows[0]
    src_id = row.cells[0].textContent
    <!--highlightFeature(src_id)-->
    $("#place_list tbody").find('tr').eq(0).addClass('highlight-row')
    <!--getPlace(pid)-->
    getPlace(src_id, '{{ ds_id }}')
  }
  function getPlace(src_id, ds_id){
    console.log('fetch record and hits for: '+ds_id+' ('+src_id+')')
  }
  $(".help-matches").click(function(){
    page=$(this).data('id')
    $('.selector').dialog('open');
  })
  $(".selector").dialog({
    resizable: false,
    autoOpen: false,
    height: 600,
    width: 700,
    title: "WHG Help",
    modal: true,
    buttons: {
      'Close': function() {
        $(this).dialog('close');
      }
    },
    open: function(event, ui) {
      $('.selector').load('/media/help/'+page+'.html');
    },
    show: {effect: "fade",duration: 400 },
    hide: {effect: "fade",duration: 400 }
   });
   
  $('.ext').on('click', function(e) {
    e.preventDefault();
    str=$(this).text()
    var re = /(http|bnf|cerl|dbp|gn|gnd|gov|loc|pl|tgn|viaf|wd|wdlocal|whg|wp):(.*?)$/;
    url=str.match(re)[1]=='http' ? str : base_urls[str.match(re)[1]]+str.match(re)[2]
    console.log('str, url',str, url)
    window.open(url,'_blank')
  });
  // recon authority external links (wd, tgn)
  $('.ext-recon').on('click', function(e) {
    e.preventDefault();
    id=$(this).text()
    url = base_urls[$(this).data('auth')]+id.toString()
    <!--console.log('id, url',id,url)-->
    window.open(url,'_blank')
  });

  var ds = "{{ ds_label }}"+':'
  $("#btn_save").click(function(){
    current_place = $('input[name=place_id]').val()
    sessionStorage.setItem('reviewBegun',true)
    // update lastPlace pid in sessionStorage on every save
    sessionStorage.setItem('lastPlace', current_place)
  })
  $("#undo").click(function(e){
    e.preventDefault()
    url = $(this).data('url').replace('999',sessionStorage.lastPlace)
    console.log('undo url:',url)
    document.location.href = url
  })
  $(function(){
    // on each page load...
    setRowEvents()
    current_place = $('input[name=place_id]').val()
    <!--console.log('lastPlace:',sessionStorage.lastPlace)-->
    <!--console.log('current place:', $('input[name=place_id]').val())-->
    // show undo link if there is a lastPlace & it's not the current place
    if((sessionStorage.lastPlace && sessionStorage.lastPlace != current_place)){
      $("#undo").removeClass('hidden-imp')}
    // set pass dropdown as next set with any reviewed=False rows
    $( "#select_pass" ).val("{{ passnum }}")
    // defaults to string 'None' - no idea why
    $('.textarea').html('')
    z=window.location.href
    $('#passnum_dynamic').html('<b>'+z.slice(-6)+'</b>')
    
    <!--$(".create-comment").each(function () {-->
      <!--var recpk = $(this).data('id');-->
      <!--uribase="/comment/"+recpk-->
      <!--next='?next='+"{ url 'datasets:review' pk=ds_id tid=task_id passnum=passnum %}"-->
      <!--$(this).modalForm({formURL: uribase+next});-->
    <!--});-->
    
    $("[rel='tooltip']").tooltip();
  })
            
  // expose leaflet map for events, call it 'mappy'
  window.addEventListener('map:init', function (e) {
    window.mappy = e.detail.map
    <!--var attrib_mb = 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +-->
            <!--'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +-->
            <!--'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',-->
    var attrib_mb = 'attrib into a popup',
      <!--attrib_mb_lite = 'Map data &copy; OSM, (CC-BY-SA), '+ 'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',-->
      attrib_mb_lite = 'attrib into a popup',
      token_mb = '{{ mbtokenmb }}',
      mbstyle_url = 'https://api.mapbox.com/styles/v1/{id}/tiles/256/{z}/{x}/{y}?access_token={token}';
      
    var satellite  = L.tileLayer(mbstyle_url, {
      id:'mapbox/satellite-streets-v11', 
      token:token_mb, 
      <!--attribution:attrib_mb-->
      }),
    osm  = L.tileLayer(mbstyle_url, {
      id:'mapbox/light-v10',
      token:token_mb,
      <!--attribution:attrib_mb-->
      });

    var baseLayers = {
      "OSM": osm,
      "Satellite": satellite
    };
    L.control.layers(baseLayers).addTo(mappy);
    baseLayers['OSM'].addTo(mappy)
  }, false);


  //
  $( "#select_pass" ).change(function() {
    z=window.location.href
    baseurl=z.substring(0,z.lastIndexOf('/')+1)
    window.location.href = baseurl + $(this).val()
  });

  $('.noteicon').on('click', function(){
    $(this).parents(".matchbar").find(".notefield").toggle()
  })

  $('.noteicon').hover(function(){
    console.log('hovering')
  })

  $( ".geolink" ).hover(function() {
      <!--console.log($(this))-->
      let id = $(this)[0].id
      <!--console.log('id:',id)-->
      feat = idToFeature[id]
      ogcolor = feat.options.fillColor
      feat.setStyle(
        {radius: 10, fillColor: 'yellow', color: 'red'}
      )
    },
    function() {
      let id = $(this)[0].id
      feat = idToFeature[id]
      feat.setStyle(
        {radius: 8, fillColor: ogcolor, color: '#333' }
      )
    }
  );

  // closer look
  function zoomTo(id) {
    mappy.setView(idToFeature[id]._latlng, mappy.getZoom() +2 )
  }

  cleanJson = function(text) {
    z=text.replace(/'/g,'\\"')
    y=z.replace(/point/,'Point')
    return JSON.parse(JSON.parse(y))
  }

  // initialize, render map
  // authority geom "geoms": [{"type": "point", "coordinates": [-72.8667, -13.6167]}]
  function map_init (map, options) {
    // console.log('in map_init()')
    window.geom = {"type":"FeatureCollecton","features":[]}

    window.gelems = $('script').filter(function() {
      <!--return this.id.match(/[0-9]/) && this.text != '"null"';-->
      return this.id !='' && this.text != '"null"';
    });
    <!--console.log(gelems)-->
    for (i=0;i<gelems.length;i++){
      let t_geom = cleanJson(gelems[i].text)
      t_geom['properties'] = {"id": gelems[i].id,"ds": t_geom.ds!=null?t_geom.ds:ds}
      <!-- citation does not always have id-->
      <!--if ('citation' in t_geom){-->
        <!--t_geom['properties'] = {"id":t_geom['citation']['id'] }-->
      <!--} else t_geom['properties'] = {"id": gelems[i].id,"ds": t_geom.ds!=null?t_geom.ds:ds}-->
      geom['features'].push(t_geom)
    }

    function fill(ds) {
      <!--console.log('ds',ds)-->
      if (['tgn','wd','whg'].indexOf(ds)>=0){
        return "orange"}
      else {
        return "green"}
    }

    if (geom['features'].length > 0) {
      <!--console.log('geom: ',geom)-->
      idToFeature = {} // for feature lookup
      features = L.geoJSON(geom, {
        pointToLayer: function (feature, latlng) {
          <!--console.log('feature.properties',feature.properties)-->
          <!--console.log('feature',feature)-->
          matchid = feature.properties.id
          marker = L.circleMarker(latlng,
            {
              radius: 8, fillOpacity: 0.4, opacity: 1, weight: 1,
              color: "#333", fillColor: fill(feature.properties.ds)
            }
          ).bindPopup(feature.properties.id);

          idToFeature[matchid] = marker
          return marker
        }
      }).addTo(map);

      <!--mappy.setView(features.getBounds().getCenter(),6)-->
      mappy.fitBounds(features.getBounds())
      mappy.setZoom(mappy.getZoom()-1)
    } else {
      console.log('no geometries, no feature')
    }
  } // end map_init
</script>
<script src="{% static 'js/jquery.bootstrap.modal.forms.min.js' %}"></script>
{% endblock %}
<!--<div id="ext_site" class="modal fade" role="dialog">-->
  <!--<div class="modal-dialog">-->
    <!--<div class="modal-content">-->
      <!--<div class="modal-header">-->
        <!--<button type="button" class="close" data-dismiss="modal" aria-label="Close">-->
          <!--<span aria-hidden="true">&times;</span></button>-->
      <!--</div>-->
      <!--<div id="ext_content" class="modal-body">foo</div>-->
    <!--</div>-->
  <!--</div>-->
<!--</div> <!-- ext_site -->
